<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#166534">
<title>Botiga Cris - Gestio d'Inventari</title>
<link rel="manifest" href="./manifest.json">
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        verd: { 50:'#f0fdf4', 100:'#dcfce7', 200:'#bbf7d0', 300:'#86efac', 400:'#4ade80', 500:'#22c55e', 600:'#16a34a', 700:'#166534', 800:'#14532d', 900:'#052e16' }
      }
    }
  }
}
</script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
  * { font-family: 'Nunito', sans-serif; -webkit-tap-highlight-color: transparent; }
  body { font-size: 17px; overscroll-behavior: none; }
  input, select, textarea { font-size: 18px !important; }
  .btn-big { min-height: 52px; font-size: 19px; }
  .card-product { transition: transform 0.1s; }
  .card-product:active { transform: scale(0.97); }
  .fab { position: fixed; bottom: 28px; right: 20px; width: 68px; height: 68px; border-radius: 50%; font-size: 36px; z-index: 40; box-shadow: 0 4px 16px rgba(0,0,0,0.25); }
  .fab-mic { position: fixed; bottom: 108px; right: 20px; width: 64px; height: 64px; border-radius: 50%; z-index: 40; box-shadow: 0 4px 16px rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center; border: 3px solid #7c3aed; background: #6d28d9; cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; }
  .fab-mic:active { transform: scale(0.9); }
  .fab-mic svg { width: 32px; height: 32px; fill: white; }
  .fab-mic.listening { animation: micPulse 1s ease-in-out infinite; background: #dc2626; border-color: #ef4444; }
  .fab-mic.processing { background: #6d28d9; border-color: #7c3aed; }
  .fab-mic.processing svg { animation: micSpin 0.8s linear infinite; }
  .fab-mic.success { background: #16a34a; border-color: #22c55e; }
  .fab-mic.error { background: #dc2626; border-color: #ef4444; }
  @keyframes micPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(220,38,38,0.5), 0 4px 16px rgba(0,0,0,0.25); } 50% { box-shadow: 0 0 0 14px rgba(220,38,38,0), 0 4px 16px rgba(0,0,0,0.25); } }
  @keyframes micSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .voice-overlay { position: fixed; bottom: 0; left: 0; right: 0; z-index: 45; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); border-radius: 24px 24px 0 0; padding: 20px 20px 32px; transform: translateY(100%); transition: transform 0.3s ease-out; }
  .voice-overlay.visible { transform: translateY(0); }
  .voice-status { font-size: 15px; font-weight: 700; color: #a78bfa; text-align: center; margin-bottom: 8px; }
  .voice-text { font-size: 20px; font-weight: 800; color: white; text-align: center; min-height: 30px; margin-bottom: 8px; }
  .voice-parsed { font-size: 14px; color: #d1d5db; text-align: center; }
  .voice-dots span { display: inline-block; width: 8px; height: 8px; margin: 0 3px; background: #a78bfa; border-radius: 50%; animation: voiceDot 1.2s infinite; }
  .voice-dots span:nth-child(2) { animation-delay: 0.2s; }
  .voice-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes voiceDot { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1.2); opacity: 1; } }
  .modal-overlay { background: rgba(0,0,0,0.45); backdrop-filter: blur(2px); }
  .slide-up { animation: slideUp 0.25s ease-out; }
  @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .badge { min-width: 24px; height: 24px; font-size: 13px; }
  ::-webkit-scrollbar { display: none; }
  .cat-btn { scroll-snap-align: start; }
  .cat-scroll { scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
  input[type="date"] { min-height: 48px; }
  select { min-height: 48px; }
</style>
</head>
<body class="bg-verd-50 min-h-screen pb-28">

<!-- HEADER -->
<header class="bg-verd-700 text-white px-4 pt-3 pb-3 sticky top-0 z-30 shadow-lg">
  <div class="flex items-center justify-between mb-2">
    <div class="flex items-center gap-2">
      <span class="text-2xl">üåø</span>
      <h1 class="text-xl font-extrabold tracking-tight">Botiga Cris</h1>
    </div>
    <div class="flex gap-2">
      <button onclick="exportCSV()" title="Exportar" class="bg-verd-600 hover:bg-verd-500 rounded-xl px-3 py-2 text-lg font-bold active:scale-95 transition">
        üì§
      </button>
      <label title="Importar" class="bg-verd-600 hover:bg-verd-500 rounded-xl px-3 py-2 text-lg font-bold cursor-pointer active:scale-95 transition">
        üì•
        <input type="file" accept=".csv" onchange="importCSV(event)" class="hidden">
      </label>
    </div>
  </div>
  <!-- SEARCH -->
  <div class="relative">
    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-verd-300 text-xl">üîç</span>
    <input id="searchInput" type="search" placeholder="Cercar producte..."
      class="w-full pl-10 pr-4 py-3 rounded-xl bg-verd-600 text-white placeholder-verd-200 font-semibold text-lg border-2 border-verd-500 focus:border-verd-300 focus:outline-none"
      oninput="renderProducts()">
  </div>
</header>

<!-- SUMMARY BAR -->
<div id="summaryBar" class="bg-white border-b border-verd-200 px-4 py-2 flex justify-around text-center shadow-sm">
  <div>
    <div id="sumTotal" class="text-2xl font-extrabold text-verd-700">0</div>
    <div class="text-xs text-gray-500 font-semibold">Productes</div>
  </div>
  <div class="border-l border-verd-200"></div>
  <div>
    <div id="sumExpiring" class="text-2xl font-extrabold text-orange-500">0</div>
    <div class="text-xs text-gray-500 font-semibold">Per caducar</div>
  </div>
  <div class="border-l border-verd-200"></div>
  <div>
    <div id="sumLowStock" class="text-2xl font-extrabold text-red-500">0</div>
    <div class="text-xs text-gray-500 font-semibold">Poc estoc</div>
  </div>
</div>

<!-- CATEGORY FILTER -->
<div class="bg-white border-b border-verd-100 px-2 py-2 overflow-x-auto cat-scroll flex gap-2 whitespace-nowrap shadow-sm">
  <button onclick="setCategory('Totes')" data-cat="Totes" class="cat-btn cat-active px-4 py-2 rounded-full font-bold text-base border-2 border-verd-600 bg-verd-600 text-white min-h-[44px] active:scale-95 transition">
    Totes
  </button>
  <button onclick="setCategory('Alimentaci√≥')" data-cat="Alimentaci√≥" class="cat-btn px-4 py-2 rounded-full font-bold text-base border-2 border-verd-300 text-verd-700 bg-verd-50 min-h-[44px] active:scale-95 transition">
    üçØ Alimentaci√≥
  </button>
  <button onclick="setCategory('Cosm√®tica')" data-cat="Cosm√®tica" class="cat-btn px-4 py-2 rounded-full font-bold text-base border-2 border-verd-300 text-verd-700 bg-verd-50 min-h-[44px] active:scale-95 transition">
    üß¥ Cosm√®tica
  </button>
  <button onclick="setCategory('Suplements')" data-cat="Suplements" class="cat-btn px-4 py-2 rounded-full font-bold text-base border-2 border-verd-300 text-verd-700 bg-verd-50 min-h-[44px] active:scale-95 transition">
    üíä Suplements
  </button>
  <button onclick="setCategory('Infusions')" data-cat="Infusions" class="cat-btn px-4 py-2 rounded-full font-bold text-base border-2 border-verd-300 text-verd-700 bg-verd-50 min-h-[44px] active:scale-95 transition">
    üçµ Infusions
  </button>
  <button onclick="setCategory('Higiene')" data-cat="Higiene" class="cat-btn px-4 py-2 rounded-full font-bold text-base border-2 border-verd-300 text-verd-700 bg-verd-50 min-h-[44px] active:scale-95 transition">
    üßº Higiene
  </button>
  <button onclick="setCategory('Altres')" data-cat="Altres" class="cat-btn px-4 py-2 rounded-full font-bold text-base border-2 border-verd-300 text-verd-700 bg-verd-50 min-h-[44px] active:scale-95 transition">
    üì¶ Altres
  </button>
</div>

<!-- PRODUCT LIST -->
<main id="productList" class="px-3 py-3 space-y-3">
</main>

<!-- EMPTY STATE -->
<div id="emptyState" class="hidden text-center py-16 px-6">
  <div class="text-6xl mb-4">üå±</div>
  <p class="text-xl font-bold text-gray-400">Cap producte trobat</p>
  <p class="text-gray-400 mt-1">Prem el boto + per afegir-ne un</p>
</div>

<!-- FAB MIC BUTTON -->
<button id="micFab" onclick="toggleVoice()" class="fab-mic" title="Entrada per veu">
  <svg id="micIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
  <svg id="micIconStop" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display:none"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
  <svg id="micIconCheck" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display:none"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
  <svg id="micIconX" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display:none"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
</button>

<!-- VOICE OVERLAY -->
<div id="voiceOverlay" class="voice-overlay">
  <div id="voiceStatus" class="voice-status">Escoltant...</div>
  <div id="voiceText" class="voice-text"></div>
  <div id="voiceDots" class="voice-dots" style="text-align:center"><span></span><span></span><span></span></div>
  <div id="voiceParsed" class="voice-parsed"></div>
</div>

<!-- FAB ADD BUTTON -->
<button onclick="openModal()" class="fab bg-verd-600 hover:bg-verd-500 text-white flex items-center justify-center shadow-xl active:scale-90 transition font-bold border-4 border-verd-400">
  Ôºã
</button>

<!-- MODAL (Add/Edit) -->
<div id="modal" class="fixed inset-0 z-50 hidden">
  <div class="modal-overlay absolute inset-0" onclick="closeModal()"></div>
  <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl slide-up max-h-[92vh] overflow-y-auto">
    <div class="sticky top-0 bg-white rounded-t-3xl z-10 px-5 pt-4 pb-2 border-b border-gray-100">
      <div class="flex items-center justify-between">
        <h2 id="modalTitle" class="text-xl font-extrabold text-verd-700">Afegir producte</h2>
        <button onclick="closeModal()" class="text-3xl text-gray-400 hover:text-gray-600 px-2 active:scale-90 transition">‚úï</button>
      </div>
      <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mt-2"></div>
    </div>
    <form id="productForm" onsubmit="saveProduct(event)" class="px-5 py-4 space-y-4 pb-8">
      <input type="hidden" id="editId" value="">

      <div>
        <label class="block text-base font-bold text-gray-600 mb-1">Nom del producte *</label>
        <input id="fName" type="text" required placeholder="Ex: Oli de coco bio"
          class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-lg font-semibold focus:border-verd-500 focus:outline-none focus:ring-2 focus:ring-verd-200">
      </div>

      <div>
        <label class="block text-base font-bold text-gray-600 mb-1">Categoria *</label>
        <select id="fCategory" required
          class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-lg font-semibold focus:border-verd-500 focus:outline-none bg-white focus:ring-2 focus:ring-verd-200">
          <option value="">-- Tria categoria --</option>
          <option value="Alimentaci√≥">üçØ Alimentaci√≥</option>
          <option value="Cosm√®tica">üß¥ Cosm√®tica</option>
          <option value="Suplements">üíä Suplements</option>
          <option value="Infusions">üçµ Infusions</option>
          <option value="Higiene">üßº Higiene</option>
          <option value="Altres">üì¶ Altres</option>
        </select>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-base font-bold text-gray-600 mb-1">Quantitat *</label>
          <div class="flex items-center border-2 border-gray-200 rounded-xl overflow-hidden focus-within:border-verd-500 focus-within:ring-2 focus-within:ring-verd-200">
            <button type="button" onclick="adjustQty(-1)" class="px-4 py-3 text-2xl font-bold text-verd-700 bg-gray-50 hover:bg-gray-100 active:bg-gray-200 min-h-[52px]">‚àí</button>
            <input id="fQuantity" type="number" min="0" required value="1"
              class="w-full text-center text-xl font-bold border-0 focus:outline-none py-3">
            <button type="button" onclick="adjustQty(1)" class="px-4 py-3 text-2xl font-bold text-verd-700 bg-gray-50 hover:bg-gray-100 active:bg-gray-200 min-h-[52px]">Ôºã</button>
          </div>
        </div>
        <div>
          <label class="block text-base font-bold text-gray-600 mb-1">Caducitat</label>
          <input id="fExpiry" type="date"
            class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-lg font-semibold focus:border-verd-500 focus:outline-none focus:ring-2 focus:ring-verd-200">
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-base font-bold text-gray-600 mb-1">Preu compra (‚Ç¨)</label>
          <input id="fPriceBuy" type="number" step="0.01" min="0" placeholder="0.00"
            class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-lg font-semibold focus:border-verd-500 focus:outline-none focus:ring-2 focus:ring-verd-200">
        </div>
        <div>
          <label class="block text-base font-bold text-gray-600 mb-1">Preu venda (‚Ç¨)</label>
          <input id="fPriceSell" type="number" step="0.01" min="0" placeholder="0.00"
            class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-lg font-semibold focus:border-verd-500 focus:outline-none focus:ring-2 focus:ring-verd-200">
        </div>
      </div>

      <button type="submit" id="btnSave"
        class="w-full bg-verd-600 hover:bg-verd-500 text-white font-extrabold text-xl py-4 rounded-xl shadow-lg active:scale-95 transition btn-big mt-2">
        ‚úÖ Guardar producte
      </button>

      <button type="button" id="btnDelete" onclick="deleteProduct()" class="hidden w-full bg-red-500 hover:bg-red-600 text-white font-extrabold text-xl py-4 rounded-xl shadow-lg active:scale-95 transition btn-big">
        üóëÔ∏è Esborrar producte
      </button>
    </form>
  </div>
</div>

<!-- CONFIRM DELETE MODAL -->
<div id="confirmModal" class="fixed inset-0 z-[60] hidden">
  <div class="modal-overlay absolute inset-0" onclick="closeConfirm()"></div>
  <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl slide-up px-5 py-6 pb-10">
    <div class="text-center mb-5">
      <div class="text-5xl mb-3">‚ö†Ô∏è</div>
      <h3 class="text-xl font-extrabold text-gray-800">Segur que vols esborrar?</h3>
      <p id="confirmName" class="text-lg text-gray-500 mt-1 font-semibold"></p>
    </div>
    <div class="flex gap-3">
      <button onclick="closeConfirm()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-extrabold text-xl py-4 rounded-xl active:scale-95 transition btn-big">
        No, torna
      </button>
      <button onclick="confirmDelete()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-extrabold text-xl py-4 rounded-xl active:scale-95 transition btn-big">
        Si, esborra
      </button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-2xl font-bold text-lg shadow-xl z-[70] hidden transition-opacity"></div>

<script>
const STORAGE_KEY = 'botigaCris_products';
const CAT_EMOJI = { 'Alimentaci√≥':'üçØ', 'Cosm√®tica':'üß¥', 'Suplements':'üíä', 'Infusions':'üçµ', 'Higiene':'üßº', 'Altres':'üì¶' };

let products = [];
let currentCategory = 'Totes';
let deleteTargetId = null;

// --- DATA ---
function loadProducts() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (raw) {
    products = JSON.parse(raw);
  } else {
    products = getDefaultProducts();
    saveToStorage();
  }
}

function saveToStorage() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
}

function getDefaultProducts() {
  const today = new Date();
  const d = (days) => {
    const dt = new Date(today);
    dt.setDate(dt.getDate() + days);
    return dt.toISOString().split('T')[0];
  };
  return [
    { id: genId(), name: 'Oli de coco bio', category: 'Alimentaci√≥', quantity: 8, expiry: d(120), priceBuy: 4.50, priceSell: 8.95 },
    { id: genId(), name: 'Infusio de camamilla', category: 'Infusions', quantity: 15, expiry: d(200), priceBuy: 1.80, priceSell: 3.50 },
    { id: genId(), name: 'Crema facial aloe vera', category: 'Cosm√®tica', quantity: 2, expiry: d(25), priceBuy: 6.00, priceSell: 12.90 },
    { id: genId(), name: 'Quinoa eco 500g', category: 'Alimentaci√≥', quantity: 5, expiry: d(5), priceBuy: 3.20, priceSell: 5.95 },
    { id: genId(), name: 'Sabo de marsella', category: 'Higiene', quantity: 12, expiry: '', priceBuy: 2.10, priceSell: 4.50 },
    { id: genId(), name: 'Mel ecologica 1kg', category: 'Alimentaci√≥', quantity: 1, expiry: d(300), priceBuy: 7.00, priceSell: 13.50 },
  ];
}

function genId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
}

// --- EXPIRY HELPERS ---
function getExpiryStatus(expiry) {
  if (!expiry) return 'ok';
  const today = new Date(); today.setHours(0,0,0,0);
  const exp = new Date(expiry + 'T00:00:00');
  const diff = Math.ceil((exp - today) / (1000*60*60*24));
  if (diff < 0) return 'expired';
  if (diff <= 7) return 'critical';
  if (diff <= 30) return 'warning';
  return 'ok';
}

function formatDate(d) {
  if (!d) return '‚Äî';
  const parts = d.split('-');
  return parts[2] + '/' + parts[1] + '/' + parts[0];
}

function daysUntilExpiry(expiry) {
  if (!expiry) return null;
  const today = new Date(); today.setHours(0,0,0,0);
  const exp = new Date(expiry + 'T00:00:00');
  return Math.ceil((exp - today) / (1000*60*60*24));
}

// --- RENDER ---
function renderProducts() {
  const search = document.getElementById('searchInput').value.toLowerCase().trim();
  let filtered = products.filter(p => {
    if (currentCategory !== 'Totes' && p.category !== currentCategory) return false;
    if (search && !p.name.toLowerCase().includes(search)) return false;
    return true;
  });

  // Sort: expired/critical first, then warning, then rest
  filtered.sort((a, b) => {
    const order = { expired: 0, critical: 1, warning: 2, ok: 3 };
    const sa = order[getExpiryStatus(a.expiry)];
    const sb = order[getExpiryStatus(b.expiry)];
    if (sa !== sb) return sa - sb;
    return a.name.localeCompare(b.name, 'ca');
  });

  const list = document.getElementById('productList');
  const empty = document.getElementById('emptyState');

  if (filtered.length === 0) {
    list.innerHTML = '';
    empty.classList.remove('hidden');
  } else {
    empty.classList.add('hidden');
    list.innerHTML = filtered.map(p => renderCard(p)).join('');
  }

  updateSummary();
}

function renderCard(p) {
  const status = getExpiryStatus(p.expiry);
  const days = daysUntilExpiry(p.expiry);
  const lowStock = p.quantity <= 2;

  let borderColor = 'border-gray-100';
  let bgColor = 'bg-white';
  let expiryBadge = '';
  let nameClass = 'text-gray-800';

  if (status === 'expired') {
    borderColor = 'border-red-400';
    bgColor = 'bg-red-50';
    expiryBadge = `<span class="inline-block bg-red-700 text-white text-xs font-bold px-2 py-0.5 rounded-full ml-1">CADUCAT</span>`;
    nameClass = 'text-red-700 line-through';
  } else if (status === 'critical') {
    borderColor = 'border-red-300';
    bgColor = 'bg-red-50';
    expiryBadge = `<span class="inline-block bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full ml-1">${days} dies</span>`;
  } else if (status === 'warning') {
    borderColor = 'border-orange-300';
    bgColor = 'bg-orange-50';
    expiryBadge = `<span class="inline-block bg-orange-400 text-white text-xs font-bold px-2 py-0.5 rounded-full ml-1">${days} dies</span>`;
  }

  const stockWarning = lowStock ? `<span class="text-lg" title="Poc estoc!">‚ö†Ô∏è</span>` : '';

  const emoji = CAT_EMOJI[p.category] || 'üì¶';

  return `
    <div onclick="editProduct('${p.id}')" class="card-product ${bgColor} border-2 ${borderColor} rounded-2xl px-4 py-3 shadow-sm cursor-pointer">
      <div class="flex items-start justify-between gap-2">
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-1 flex-wrap">
            <span class="text-lg">${emoji}</span>
            <span class="font-extrabold text-lg ${nameClass} truncate">${escHtml(p.name)}</span>
            ${expiryBadge}
          </div>
          <div class="flex items-center gap-3 mt-1 text-sm text-gray-500 font-semibold flex-wrap">
            <span>${p.category}</span>
            ${p.expiry ? `<span>üìÖ ${formatDate(p.expiry)}</span>` : ''}
            ${p.priceSell ? `<span>üí∞ ${Number(p.priceSell).toFixed(2)}‚Ç¨</span>` : ''}
          </div>
        </div>
        <div class="flex flex-col items-center ml-2 min-w-[52px]">
          <div class="flex items-center gap-1">
            ${stockWarning}
            <span class="text-2xl font-extrabold ${lowStock ? 'text-red-500' : 'text-verd-700'}">${p.quantity}</span>
          </div>
          <span class="text-xs text-gray-400 font-bold">unitats</span>
        </div>
      </div>
    </div>
  `;
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function updateSummary() {
  const total = products.length;
  let expiring = 0;
  let lowStock = 0;
  products.forEach(p => {
    const s = getExpiryStatus(p.expiry);
    if (s === 'expired' || s === 'critical' || s === 'warning') expiring++;
    if (p.quantity <= 2) lowStock++;
  });
  document.getElementById('sumTotal').textContent = total;
  document.getElementById('sumExpiring').textContent = expiring;
  document.getElementById('sumLowStock').textContent = lowStock;
}

// --- CATEGORY FILTER ---
function setCategory(cat) {
  currentCategory = cat;
  document.querySelectorAll('.cat-btn').forEach(btn => {
    if (btn.dataset.cat === cat) {
      btn.className = 'cat-btn px-4 py-2 rounded-full font-bold text-base border-2 border-verd-600 bg-verd-600 text-white min-h-[44px] active:scale-95 transition';
    } else {
      btn.className = 'cat-btn px-4 py-2 rounded-full font-bold text-base border-2 border-verd-300 text-verd-700 bg-verd-50 min-h-[44px] active:scale-95 transition';
    }
  });
  renderProducts();
}

// --- MODAL ---
function openModal(id) {
  document.getElementById('modal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  if (id) {
    const p = products.find(x => x.id === id);
    if (!p) return;
    document.getElementById('modalTitle').textContent = 'Editar producte';
    document.getElementById('editId').value = p.id;
    document.getElementById('fName').value = p.name;
    document.getElementById('fCategory').value = p.category;
    document.getElementById('fQuantity').value = p.quantity;
    document.getElementById('fExpiry').value = p.expiry || '';
    document.getElementById('fPriceBuy').value = p.priceBuy || '';
    document.getElementById('fPriceSell').value = p.priceSell || '';
    document.getElementById('btnSave').textContent = '‚úÖ Guardar canvis';
    document.getElementById('btnDelete').classList.remove('hidden');
  } else {
    document.getElementById('modalTitle').textContent = 'Afegir producte';
    document.getElementById('editId').value = '';
    document.getElementById('productForm').reset();
    document.getElementById('fQuantity').value = 1;
    document.getElementById('btnSave').textContent = '‚úÖ Guardar producte';
    document.getElementById('btnDelete').classList.add('hidden');
  }
}

function closeModal() {
  document.getElementById('modal').classList.add('hidden');
  document.body.style.overflow = '';
}

function editProduct(id) {
  openModal(id);
}

function adjustQty(delta) {
  const input = document.getElementById('fQuantity');
  let val = parseInt(input.value) || 0;
  val = Math.max(0, val + delta);
  input.value = val;
}

// --- SAVE ---
function saveProduct(e) {
  e.preventDefault();
  const id = document.getElementById('editId').value;
  const data = {
    id: id || genId(),
    name: document.getElementById('fName').value.trim(),
    category: document.getElementById('fCategory').value,
    quantity: parseInt(document.getElementById('fQuantity').value) || 0,
    expiry: document.getElementById('fExpiry').value || '',
    priceBuy: parseFloat(document.getElementById('fPriceBuy').value) || 0,
    priceSell: parseFloat(document.getElementById('fPriceSell').value) || 0,
  };

  if (id) {
    const idx = products.findIndex(p => p.id === id);
    if (idx !== -1) products[idx] = data;
    showToast('Producte actualitzat ‚úÖ');
  } else {
    products.push(data);
    showToast('Producte afegit ‚úÖ');
  }

  saveToStorage();
  closeModal();
  renderProducts();
}

// --- DELETE ---
function deleteProduct() {
  const id = document.getElementById('editId').value;
  if (!id) return;
  const p = products.find(x => x.id === id);
  deleteTargetId = id;
  document.getElementById('confirmName').textContent = p ? p.name : '';
  document.getElementById('confirmModal').classList.remove('hidden');
}

function confirmDelete() {
  if (deleteTargetId) {
    products = products.filter(p => p.id !== deleteTargetId);
    saveToStorage();
    showToast('Producte esborrat üóëÔ∏è');
    deleteTargetId = null;
  }
  closeConfirm();
  closeModal();
  renderProducts();
}

function closeConfirm() {
  document.getElementById('confirmModal').classList.add('hidden');
  deleteTargetId = null;
}

// --- TOAST ---
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.remove('hidden');
  t.style.opacity = '1';
  setTimeout(() => {
    t.style.opacity = '0';
    setTimeout(() => t.classList.add('hidden'), 300);
  }, 2000);
}

// --- CSV EXPORT ---
function exportCSV() {
  if (products.length === 0) { showToast('No hi ha productes per exportar'); return; }
  const headers = ['Nom','Categoria','Quantitat','Caducitat','Preu Compra','Preu Venda'];
  const rows = products.map(p => [
    '"' + p.name.replace(/"/g, '""') + '"',
    p.category,
    p.quantity,
    p.expiry || '',
    p.priceBuy || '',
    p.priceSell || ''
  ]);
  const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const date = new Date().toISOString().split('T')[0];
  a.href = url;
  a.download = `inventari_botigaCris_${date}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Arxiu CSV exportat üì§');
}

// --- CSV IMPORT ---
function importCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const text = e.target.result;
      const lines = text.split('\n').filter(l => l.trim());
      if (lines.length < 2) { showToast('Arxiu buit o inv√†lid'); return; }

      const imported = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(';').map(c => c.replace(/^"|"$/g, '').trim());
        if (cols.length < 2) continue;
        imported.push({
          id: genId(),
          name: cols[0] || 'Sense nom',
          category: cols[1] || 'Altres',
          quantity: parseInt(cols[2]) || 0,
          expiry: cols[3] || '',
          priceBuy: parseFloat(cols[4]) || 0,
          priceSell: parseFloat(cols[5]) || 0,
        });
      }

      if (imported.length === 0) { showToast('Cap producte trobat a l\'arxiu'); return; }

      products = imported;
      saveToStorage();
      renderProducts();
      showToast(`${imported.length} productes importats üì•`);
    } catch (err) {
      showToast('Error llegint l\'arxiu');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// --- QUICK STOCK ADJUSTMENT (from list) ---
// Long press to open quick quantity adjustment
let longPressTimer = null;

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
  loadProducts();
  renderProducts();
});

// ==========================================
// VOICE INPUT FEATURE
// ==========================================

const VoiceState = { IDLE: 'idle', LISTENING: 'listening', PROCESSING: 'processing', SUCCESS: 'success', ERROR: 'error' };
let voiceState = VoiceState.IDLE;
let recognition = null;
let voiceSpeechSupported = false;

// Number words in Catalan
const CATALAN_NUMBERS = {
  'zero':0,'un':1,'una':1,'dos':2,'dues':2,'tres':3,'quatre':4,'cinc':5,'sis':6,'set':7,'vuit':8,'nou':9,
  'deu':10,'onze':11,'dotze':12,'tretze':13,'catorze':14,'quinze':15,'setze':16,'disset':17,'divuit':18,'dinou':19,
  'vint':20,'vint-i-un':21,'vint-i-una':21,'vint-i-dos':22,'vint-i-dues':22,'vint-i-tres':23,'vint-i-quatre':24,
  'vint-i-cinc':25,'vint-i-sis':26,'vint-i-set':27,'vint-i-vuit':28,'vint-i-nou':29,
  'trenta':30,'quaranta':40,'cinquanta':50,'seixanta':60,'setanta':70,'vuitanta':80,'noranta':90,'cent':100,
  'dos-cents':200,'tres-cents':300,'quatre-cents':400,'cinc-cents':500,
  'mil':1000,'dos mil':2000
};

const CATALAN_MONTHS = {
  'gener':1,'febrer':2,'marc':3,'mar√ß':3,'abril':4,'maig':5,'juny':6,
  'juliol':7,'agost':8,'setembre':9,'octubre':10,'novembre':11,'desembre':12
};

const CATEGORIES = ['Alimentaci√≥','Cosm√®tica','Suplements','Infusions','Higiene','Altres'];
const CATEGORY_KEYWORDS = {
  'alimentaci√≥':'Alimentaci√≥','alimentacio':'Alimentaci√≥','menjar':'Alimentaci√≥',
  'cosm√®tica':'Cosm√®tica','cosmetica':'Cosm√®tica','crema':'Cosm√®tica',
  'suplements':'Suplements','suplement':'Suplements','vitamina':'Suplements',
  'infusions':'Infusions','infusi√≥':'Infusions','infusio':'Infusions','te':'Infusions',
  'higiene':'Higiene','sab√≥':'Higiene','sabo':'Higiene',
  'altres':'Altres'
};

function initVoice() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    document.getElementById('micFab').style.display = 'none';
    return;
  }
  voiceSpeechSupported = true;
  recognition = new SpeechRecognition();
  recognition.lang = 'ca-ES';
  recognition.continuous = false;
  recognition.interimResults = true;
  recognition.maxAlternatives = 1;

  recognition.onstart = () => {
    setVoiceState(VoiceState.LISTENING);
  };

  recognition.onresult = (event) => {
    let interim = '';
    let final = '';
    for (let i = 0; i < event.results.length; i++) {
      if (event.results[i].isFinal) {
        final += event.results[i][0].transcript;
      } else {
        interim += event.results[i][0].transcript;
      }
    }
    const display = final || interim;
    document.getElementById('voiceText').textContent = display;
    if (final) {
      recognition.stop();
      processVoiceCommand(final.trim().toLowerCase());
    }
  };

  recognition.onerror = (event) => {
    if (event.error === 'not-allowed') {
      showVoiceError('Perm√≠s de micr√≤fon denegat. Activa\'l a la configuraci√≥ del navegador.');
    } else if (event.error === 'no-speech') {
      showVoiceError('No s\'ha detectat cap veu. Torna a provar.');
    } else if (event.error === 'aborted') {
      setVoiceState(VoiceState.IDLE);
    } else {
      showVoiceError('Error de reconeixement: ' + event.error);
    }
  };

  recognition.onend = () => {
    if (voiceState === VoiceState.LISTENING) {
      setVoiceState(VoiceState.IDLE);
      hideVoiceOverlay();
    }
  };
}

function toggleVoice() {
  if (!voiceSpeechSupported) {
    showToast('El teu navegador no suporta la veu');
    return;
  }
  if (voiceState === VoiceState.LISTENING) {
    recognition.stop();
    setVoiceState(VoiceState.IDLE);
    hideVoiceOverlay();
  } else if (voiceState === VoiceState.IDLE) {
    startListening();
  }
}

function startListening() {
  document.getElementById('voiceText').textContent = '';
  document.getElementById('voiceParsed').textContent = '';
  document.getElementById('voiceDots').style.display = '';
  document.getElementById('voiceStatus').textContent = 'Escoltant...';
  document.getElementById('voiceStatus').style.color = '#a78bfa';
  showVoiceOverlay();
  try {
    recognition.start();
  } catch (e) {
    showVoiceError('No s\'ha pogut iniciar el micr√≤fon.');
  }
}

function setVoiceState(state) {
  voiceState = state;
  const btn = document.getElementById('micFab');
  const icons = { mic: 'micIcon', stop: 'micIconStop', check: 'micIconCheck', x: 'micIconX' };
  Object.values(icons).forEach(id => document.getElementById(id).style.display = 'none');
  btn.classList.remove('listening', 'processing', 'success', 'error');

  switch (state) {
    case VoiceState.IDLE:
      document.getElementById('micIcon').style.display = '';
      break;
    case VoiceState.LISTENING:
      btn.classList.add('listening');
      document.getElementById('micIconStop').style.display = '';
      break;
    case VoiceState.PROCESSING:
      btn.classList.add('processing');
      document.getElementById('micIcon').style.display = '';
      break;
    case VoiceState.SUCCESS:
      btn.classList.add('success');
      document.getElementById('micIconCheck').style.display = '';
      setTimeout(() => { if (voiceState === VoiceState.SUCCESS) setVoiceState(VoiceState.IDLE); }, 2000);
      break;
    case VoiceState.ERROR:
      btn.classList.add('error');
      document.getElementById('micIconX').style.display = '';
      setTimeout(() => { if (voiceState === VoiceState.ERROR) setVoiceState(VoiceState.IDLE); }, 2500);
      break;
  }
}

function showVoiceOverlay() {
  document.getElementById('voiceOverlay').classList.add('visible');
}

function hideVoiceOverlay() {
  document.getElementById('voiceOverlay').classList.remove('visible');
}

function showVoiceError(msg) {
  setVoiceState(VoiceState.ERROR);
  document.getElementById('voiceStatus').textContent = msg;
  document.getElementById('voiceStatus').style.color = '#f87171';
  document.getElementById('voiceDots').style.display = 'none';
  setTimeout(() => { hideVoiceOverlay(); }, 3000);
}

function showVoiceSuccess(msg) {
  setVoiceState(VoiceState.SUCCESS);
  document.getElementById('voiceStatus').textContent = msg;
  document.getElementById('voiceStatus').style.color = '#4ade80';
  document.getElementById('voiceDots').style.display = 'none';
  setTimeout(() => { hideVoiceOverlay(); }, 2000);
}

// --- PARSING ---
function parseNumberWord(text) {
  // Try direct digit match first
  const digitMatch = text.match(/\d+/);
  if (digitMatch) return parseInt(digitMatch[0]);

  // Normalize text for number matching
  const normalized = text.toLowerCase().trim();

  // Try compound numbers like "trenta-cinc" or "trenta cinc"
  // Pattern: tens + (- or space + i + space or -i-) + units
  const compoundPattern = /\b(trenta|quaranta|cinquanta|seixanta|setanta|vuitanta|noranta)[\s-]+i[\s-]+(un|una|dos|dues|tres|quatre|cinc|sis|set|vuit|nou)\b/;
  const compoundMatch = normalized.match(compoundPattern);
  if (compoundMatch) {
    const tens = CATALAN_NUMBERS[compoundMatch[1]] || 0;
    const units = CATALAN_NUMBERS[compoundMatch[2]] || 0;
    return tens + units;
  }

  // Try vint-i-X pattern (already in dictionary)
  for (const [word, num] of Object.entries(CATALAN_NUMBERS)) {
    if (normalized.includes(word)) return num;
  }

  return null;
}

function extractQuantity(text) {
  // Check for "una"/"un" as quantity word early (common in speech)
  if (/\buna\b/i.test(quantityZone) || /^(?:afegeix|treu|actualitza)\s+un\b/i.test(text)) return 1;

  // Look for explicit quantity patterns (number + "unitats"/"unitat")
  const explicitQty = quantityZone.match(/(\d+)\s*unitat/i);
  if (explicitQty) return parseInt(explicitQty[1]);

  // Look for standalone numbers that are NOT part of product names (exclude numbers followed by g/kg/ml/l/cl)
  const standaloneNum = quantityZone.match(/\b(\d+)\b(?!\s*(?:g|kg|ml|l|cl)\b)/i);
  if (standaloneNum) return parseInt(standaloneNum[1]);

  // Try Catalan number words before "unitat(s)"
  const unitatPattern = /([\w\s-]+?)\s*unitat/i;
  const um = text.match(unitatPattern);
  if (um) {
    const num = parseNumberWord(um[1]);
    if (num !== null) return num;
  }

  // Try any number word in the text (scan from right to left to get the quantity, not the date)
  // But avoid picking up date-related numbers - extract quantity from before "caduca"
  let quantityZone = text;
  const caducaIdx = text.indexOf('caduca');
  if (caducaIdx > -1) quantityZone = text.substring(0, caducaIdx);

  // Sort by value descending to match longer phrases first (e.g., "vint-i-cinc" before "cinc")
  const sortedEntries = Object.entries(CATALAN_NUMBERS).sort((a, b) => b[0].length - a[0].length);
  for (const [word, num] of sortedEntries) {
    if (quantityZone.includes(word) && num > 0) return num;
  }

  return 1; // default
}

function extractExpiry(text) {
  // Look for "caduca el X de Y" or "caducitat X de Y"
  const expiryPattern = /(?:que\s+)?(?:caduca|caducitat)\s+(?:el\s+|l')?(.+)/i;
  const m = text.match(expiryPattern);
  if (!m) return '';

  const datePart = m[1].trim();
  return parseCatalanDate(datePart);
}

function parseCatalanDate(text) {
  let day = null;
  let month = null;
  let year = null;

  // Extract day (number or word)
  const dayDigit = text.match(/^(\d{1,2})/);
  if (dayDigit) {
    day = parseInt(dayDigit[1]);
  } else {
    // Try number words for day
    const sortedEntries = Object.entries(CATALAN_NUMBERS).sort((a, b) => b[0].length - a[0].length);
    for (const [word, num] of sortedEntries) {
      if (text.startsWith(word) || text.includes(word)) {
        if (num >= 1 && num <= 31) { day = num; break; }
      }
    }
  }

  // Extract month
  for (const [monthName, monthNum] of Object.entries(CATALAN_MONTHS)) {
    if (text.includes(monthName)) { month = monthNum; break; }
  }

  if (!day || !month) return '';

  // Extract year
  const yearDigit = text.match(/\b(20\d{2})\b/);
  if (yearDigit) {
    year = parseInt(yearDigit[1]);
  } else {
    // Try "dos mil vint-i-set" style years
    const yearPattern = /(?:dos\s*mil\s*)([\w\s-]+)/;
    const ym = text.match(yearPattern);
    if (ym) {
      const yearRest = parseNumberWord(ym[1]);
      if (yearRest !== null) year = 2000 + yearRest;
    }
  }

  if (!year) {
    const now = new Date();
    year = now.getFullYear();
    // If month already passed, use next year
    const testDate = new Date(year, month - 1, day);
    if (testDate < now) year++;
  }

  const mm = String(month).padStart(2, '0');
  const dd = String(day).padStart(2, '0');
  return `${year}-${mm}-${dd}`;
}

function extractCategory(text) {
  const lower = text.toLowerCase();
  // Check category keywords
  for (const [keyword, cat] of Object.entries(CATEGORY_KEYWORDS)) {
    if (lower.includes(keyword)) return cat;
  }
  return '';
}

function extractAction(text) {
  if (text.startsWith('treu') || text.includes(' treu ')) return 'remove';
  if (text.startsWith('actualitza') || text.includes(' actualitza ')) return 'update';
  // Default to add (covers "afegeix" and bare commands)
  return 'add';
}

function extractProductName(text) {
  let cleaned = text;

  // Remove action words at the start (including "afegeix una", "afegeix un")
  cleaned = cleaned.replace(/^(afegeix|actualitza|treu)\s+(una?\s+)?/i, '');

  // Remove quantity phrases (number + unitats/unitat) but NOT numbers followed by g/kg/ml
  cleaned = cleaned.replace(/\b\d+\s*unitats?\b/gi, '');
  // Remove Catalan number words followed by "unitat(s)"
  const sortedNums = Object.keys(CATALAN_NUMBERS).sort((a, b) => b.length - a.length);
  for (const word of sortedNums) {
    const re = new RegExp('\\b' + word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\s+unitats?\\b', 'gi');
    cleaned = cleaned.replace(re, '');
  }

  // Remove expiry phrases (with optional "que" before)
  cleaned = cleaned.replace(/(?:que\s+)?(?:caduca|caducitat)\s+.*/i, '');

  // Remove category mentions at the end
  cleaned = cleaned.replace(/\s+(?:categoria|de la categoria)\s+\w+\s*$/i, '');

  // Remove standalone number words that are likely quantities (only if they appear right before a comma or at a natural boundary)
  // Be careful not to remove numbers that are part of the product name
  cleaned = cleaned.replace(/,\s*\d+\s*/g, ',');
  cleaned = cleaned.replace(/,\s*$/g, '');

  // Remove trailing commas, clean up
  cleaned = cleaned.replace(/\s+/g, ' ').trim();
  cleaned = cleaned.replace(/^[,\s]+|[,\s]+$/g, '').trim();

  // Remove leading standalone quantity number words if they appear at the start after action removal
  // e.g., "deu unitats" was removed but "deu" alone at start might remain
  // Only remove if what follows looks like it continues
  for (const word of sortedNums) {
    const re = new RegExp('^' + word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\s*,?\\s*', 'i');
    if (cleaned.match(re) && cleaned.length > word.length + 2) {
      cleaned = cleaned.replace(re, '');
      break;
    }
  }

  cleaned = cleaned.replace(/^[,\s]+|[,\s]+$/g, '').trim();
  return cleaned;
}

function findExistingProduct(name) {
  if (!name) return null;
  const lower = name.toLowerCase();

  // Exact match
  let found = products.find(p => p.name.toLowerCase() === lower);
  if (found) return found;

  // Contains match
  found = products.find(p => p.name.toLowerCase().includes(lower) || lower.includes(p.name.toLowerCase()));
  if (found) return found;

  // Fuzzy: check if 70%+ of words match
  const words = lower.split(/\s+/);
  if (words.length >= 2) {
    let bestMatch = null;
    let bestScore = 0;
    for (const p of products) {
      const pWords = p.name.toLowerCase().split(/\s+/);
      let matchCount = 0;
      for (const w of words) {
        if (pWords.some(pw => pw.includes(w) || w.includes(pw))) matchCount++;
      }
      const score = matchCount / Math.max(words.length, pWords.length);
      if (score > bestScore && score >= 0.5) {
        bestScore = score;
        bestMatch = p;
      }
    }
    if (bestMatch) return bestMatch;
  }

  return null;
}

function processVoiceCommand(text) {
  setVoiceState(VoiceState.PROCESSING);
  document.getElementById('voiceStatus').textContent = 'Processant...';
  document.getElementById('voiceStatus').style.color = '#a78bfa';
  document.getElementById('voiceDots').style.display = 'none';

  const action = extractAction(text);
  const quantity = extractQuantity(text);
  const expiry = extractExpiry(text);
  const category = extractCategory(text);
  const productName = extractProductName(text);

  if (!productName || productName.length < 2) {
    document.getElementById('voiceParsed').innerHTML = '<span style="color:#fbbf24">No s\'ha pogut entendre el producte. Torna a provar.</span><br><span style="color:#9ca3af;font-size:12px">He sentit: "' + escHtml(text) + '"</span>';
    showVoiceError('No he ent√®s el producte. Torna a provar.');
    return;
  }

  // Show parsed result
  let parsedInfo = '<strong>' + escHtml(productName) + '</strong>';
  parsedInfo += ' &mdash; ' + quantity + ' unitat' + (quantity !== 1 ? 's' : '');
  if (expiry) parsedInfo += ' &mdash; Cad: ' + formatDate(expiry);
  if (category) parsedInfo += ' &mdash; ' + category;
  document.getElementById('voiceParsed').innerHTML = parsedInfo;

  const existing = findExistingProduct(productName);

  let confirmMsg = '';

  if (action === 'remove') {
    if (existing) {
      existing.quantity = Math.max(0, existing.quantity - quantity);
      saveToStorage();
      renderProducts();
      confirmMsg = 'Tret: ' + existing.name + ', ' + quantity + ' unitat' + (quantity !== 1 ? 's' : '') + '. Queden ' + existing.quantity;
      showToast(confirmMsg);
    } else {
      showVoiceError('No he trobat "' + productName + '" a l\'inventari.');
      return;
    }
  } else if (action === 'update') {
    if (existing) {
      existing.quantity = quantity;
      if (expiry) existing.expiry = expiry;
      if (category) existing.category = category;
      saveToStorage();
      renderProducts();
      confirmMsg = 'Actualitzat: ' + existing.name + ' a ' + quantity + ' unitat' + (quantity !== 1 ? 's' : '');
      showToast(confirmMsg);
    } else {
      showVoiceError('No he trobat "' + productName + '" a l\'inventari.');
      return;
    }
  } else {
    // Add
    if (existing) {
      existing.quantity += quantity;
      if (expiry && !existing.expiry) existing.expiry = expiry;
      saveToStorage();
      renderProducts();
      confirmMsg = 'Afegit: ' + existing.name + ' +' + quantity + ' (total: ' + existing.quantity + ')';
      showToast(confirmMsg);
    } else {
      const newProduct = {
        id: genId(),
        name: productName.charAt(0).toUpperCase() + productName.slice(1),
        category: category || 'Altres',
        quantity: quantity,
        expiry: expiry || '',
        priceBuy: 0,
        priceSell: 0,
      };
      products.push(newProduct);
      saveToStorage();
      renderProducts();
      confirmMsg = 'Afegit: ' + newProduct.name + ' - ' + quantity + ' unitat' + (quantity !== 1 ? 's' : '');
      showToast(confirmMsg);
    }
  }

  // Speech synthesis confirmation
  speakCatalan(confirmMsg);
  showVoiceSuccess(confirmMsg);
}

function speakCatalan(text) {
  if (!('speechSynthesis' in window)) return;
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'ca-ES';
  utterance.rate = 1.0;
  utterance.pitch = 1.0;
  // Try to find a Catalan voice
  const voices = speechSynthesis.getVoices();
  const catalanVoice = voices.find(v => v.lang.startsWith('ca'));
  if (catalanVoice) utterance.voice = catalanVoice;
  speechSynthesis.speak(utterance);
}

// Preload voices (some browsers need this)
if ('speechSynthesis' in window) {
  speechSynthesis.onvoiceschanged = () => { speechSynthesis.getVoices(); };
}

// Initialize voice on DOM ready
document.addEventListener('DOMContentLoaded', () => {
  initVoice();
});

// PWA: Register service worker if available (optional, for offline support)
if ('serviceWorker' in navigator) {
  // Only register if sw.js exists - graceful fallback
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}
</script>
</body>
</html>
