<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#166534">
<title>Botiga Cris - Gestio d'Inventari</title>
<link rel="manifest" href="./manifest.json">
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        verd: { 50:'#f0fdf4', 100:'#dcfce7', 200:'#bbf7d0', 300:'#86efac', 400:'#4ade80', 500:'#22c55e', 600:'#16a34a', 700:'#166534', 800:'#14532d', 900:'#052e16' }
      }
    }
  }
}
</script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap');
  * { font-family: 'Nunito', sans-serif; -webkit-tap-highlight-color: transparent; }
  body { font-size: 17px; overscroll-behavior: none; }
  input, select, textarea { font-size: 18px !important; }
  .btn-big { min-height: 52px; font-size: 19px; }
  .card-product { transition: transform 0.1s; }
  .card-product:active { transform: scale(0.97); }
  .fab { position: fixed; bottom: 28px; right: 20px; width: 68px; height: 68px; border-radius: 50%; font-size: 36px; z-index: 40; box-shadow: 0 4px 16px rgba(0,0,0,0.25); }
  .fab-mic { position: fixed; bottom: 108px; right: 20px; width: 64px; height: 64px; border-radius: 50%; z-index: 40; box-shadow: 0 4px 16px rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center; border: 3px solid #7c3aed; background: #6d28d9; cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; }
  .fab-mic:active { transform: scale(0.9); }
  .fab-mic svg { width: 32px; height: 32px; fill: white; }
  .fab-mic.listening { animation: micPulse 1s ease-in-out infinite; background: #dc2626; border-color: #ef4444; }
  .fab-mic.processing { background: #6d28d9; border-color: #7c3aed; }
  .fab-mic.processing svg { animation: micSpin 0.8s linear infinite; }
  .fab-mic.success { background: #16a34a; border-color: #22c55e; }
  .fab-mic.error { background: #dc2626; border-color: #ef4444; }
  @keyframes micPulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(220,38,38,0.5), 0 4px 16px rgba(0,0,0,0.25); } 50% { box-shadow: 0 0 0 14px rgba(220,38,38,0), 0 4px 16px rgba(0,0,0,0.25); } }
  @keyframes micSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
  .voice-overlay { position: fixed; bottom: 0; left: 0; right: 0; z-index: 45; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); border-radius: 24px 24px 0 0; padding: 20px 20px 32px; transform: translateY(100%); transition: transform 0.3s ease-out; }
  .voice-overlay.visible { transform: translateY(0); }
  .voice-status { font-size: 15px; font-weight: 700; color: #a78bfa; text-align: center; margin-bottom: 8px; }
  .voice-text { font-size: 20px; font-weight: 800; color: white; text-align: center; min-height: 30px; margin-bottom: 8px; }
  .voice-parsed { font-size: 14px; color: #d1d5db; text-align: center; }
  .quick-btn { -webkit-user-select: none; user-select: none; touch-action: manipulation; line-height: 1; }
  .quick-btn:active { transform: scale(0.85); }
  .voice-dots span { display: inline-block; width: 8px; height: 8px; margin: 0 3px; background: #a78bfa; border-radius: 50%; animation: voiceDot 1.2s infinite; }
  .voice-dots span:nth-child(2) { animation-delay: 0.2s; }
  .voice-dots span:nth-child(3) { animation-delay: 0.4s; }
  @keyframes voiceDot { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1.2); opacity: 1; } }
  .modal-overlay { background: rgba(0,0,0,0.45); backdrop-filter: blur(2px); }
  .slide-up { animation: slideUp 0.25s ease-out; }
  @keyframes slideUp { from { transform: translateY(40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .badge { min-width: 24px; height: 24px; font-size: 13px; }
  ::-webkit-scrollbar { display: none; }
  .cat-btn { scroll-snap-align: start; }
  .cat-scroll { scroll-snap-type: x mandatory; -webkit-overflow-scrolling: touch; }
  input[type="date"] { min-height: 48px; }
  select { min-height: 48px; }
</style>
</head>
<body class="bg-verd-50 min-h-screen pb-28">

<!-- HEADER -->
<header class="bg-verd-700 text-white px-4 pt-3 pb-3 sticky top-0 z-30 shadow-lg">
  <div class="flex items-center justify-between mb-2">
    <div class="flex items-center gap-2">
      <span class="text-2xl">üåø</span>
      <h1 class="text-xl font-extrabold tracking-tight">Botiga Cris</h1>
    </div>
    <div class="flex gap-2">
      <button onclick="exportCSV()" title="Exportar" class="bg-verd-600 hover:bg-verd-500 rounded-xl px-3 py-2 text-lg font-bold active:scale-95 transition">
        üì§
      </button>
      <label title="Importar" class="bg-verd-600 hover:bg-verd-500 rounded-xl px-3 py-2 text-lg font-bold cursor-pointer active:scale-95 transition">
        üì•
        <input type="file" accept=".csv" onchange="importCSV(event)" class="hidden">
      </label>
    </div>
  </div>
  <!-- SEARCH -->
  <div class="relative">
    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-verd-300 text-xl">üîç</span>
    <input id="searchInput" type="search" placeholder="Cercar producte..."
      class="w-full pl-10 pr-4 py-3 rounded-xl bg-verd-600 text-white placeholder-verd-200 font-semibold text-lg border-2 border-verd-500 focus:border-verd-300 focus:outline-none"
      oninput="renderProducts()">
  </div>
</header>

<!-- SUMMARY BAR -->
<div id="summaryBar" class="bg-white border-b border-verd-200 px-4 py-2 flex justify-around text-center shadow-sm">
  <div>
    <div id="sumTotal" class="text-2xl font-extrabold text-verd-700">0</div>
    <div class="text-xs text-gray-500 font-semibold">Productes</div>
  </div>
  <div class="border-l border-verd-200"></div>
  <div>
    <div id="sumExpiring" class="text-2xl font-extrabold text-orange-500">0</div>
    <div class="text-xs text-gray-500 font-semibold">Per caducar</div>
  </div>
  <div class="border-l border-verd-200"></div>
  <div>
    <div id="sumLowStock" class="text-2xl font-extrabold text-red-500">0</div>
    <div class="text-xs text-gray-500 font-semibold">Poc estoc</div>
  </div>
  <div class="border-l border-verd-200"></div>
  <div class="cursor-pointer active:scale-95 transition" onclick="showHistory()">
    <div class="text-2xl">üìã</div>
    <div class="text-xs text-gray-500 font-semibold">Historial</div>
  </div>
</div>

<!-- CATEGORY FILTER -->
<div class="bg-white border-b border-verd-100 px-2 py-2 overflow-x-auto cat-scroll flex gap-2 whitespace-nowrap shadow-sm">
  <button onclick="setCategory('Totes')" data-cat="Totes" class="cat-btn cat-active px-4 py-2 rounded-full font-bold text-base border-2 border-verd-600 bg-verd-600 text-white min-h-[44px] active:scale-95 transition">
    Totes
  </button>
  <button onclick="setCategory('Alimentaci√≥')" data-cat="Alimentaci√≥" class="cat-btn px-4 py-2 rounded-full font-bold text-base border-2 border-verd-300 text-verd-700 bg-verd-50 min-h-[44px] active:scale-95 transition">
    üçØ Alimentaci√≥
  </button>
  <button onclick="setCategory('Cosm√®tica')" data-cat="Cosm√®tica" class="cat-btn px-4 py-2 rounded-full font-bold text-base border-2 border-verd-300 text-verd-700 bg-verd-50 min-h-[44px] active:scale-95 transition">
    üß¥ Cosm√®tica
  </button>
  <button onclick="setCategory('Suplements')" data-cat="Suplements" class="cat-btn px-4 py-2 rounded-full font-bold text-base border-2 border-verd-300 text-verd-700 bg-verd-50 min-h-[44px] active:scale-95 transition">
    üíä Suplements
  </button>
  <button onclick="setCategory('Infusions')" data-cat="Infusions" class="cat-btn px-4 py-2 rounded-full font-bold text-base border-2 border-verd-300 text-verd-700 bg-verd-50 min-h-[44px] active:scale-95 transition">
    üçµ Infusions
  </button>
  <button onclick="setCategory('Higiene')" data-cat="Higiene" class="cat-btn px-4 py-2 rounded-full font-bold text-base border-2 border-verd-300 text-verd-700 bg-verd-50 min-h-[44px] active:scale-95 transition">
    üßº Higiene
  </button>
  <button onclick="setCategory('Altres')" data-cat="Altres" class="cat-btn px-4 py-2 rounded-full font-bold text-base border-2 border-verd-300 text-verd-700 bg-verd-50 min-h-[44px] active:scale-95 transition">
    üì¶ Altres
  </button>
</div>

<!-- PRODUCT LIST -->
<main id="productList" class="px-3 py-3 space-y-3">
</main>

<!-- EMPTY STATE -->
<div id="emptyState" class="hidden text-center py-16 px-6">
  <div class="text-6xl mb-4">üå±</div>
  <p class="text-xl font-bold text-gray-400">Cap producte trobat</p>
  <p class="text-gray-400 mt-1">Prem el boto + per afegir-ne un</p>
</div>

<!-- FAB MIC BUTTON -->
<button id="micFab" onclick="toggleVoice()" class="fab-mic" title="Entrada per veu">
  <svg id="micIcon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
  <svg id="micIconStop" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display:none"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
  <svg id="micIconCheck" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display:none"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>
  <svg id="micIconX" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="display:none"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
</button>

<!-- VOICE OVERLAY -->
<div id="voiceOverlay" class="voice-overlay">
  <div id="voiceStatus" class="voice-status">Escoltant...</div>
  <div id="voiceText" class="voice-text"></div>
  <div id="voiceDots" class="voice-dots" style="text-align:center"><span></span><span></span><span></span></div>
  <div id="voiceParsed" class="voice-parsed"></div>
</div>

<!-- FAB ADD BUTTON -->
<button onclick="openModal()" class="fab bg-verd-600 hover:bg-verd-500 text-white flex items-center justify-center shadow-xl active:scale-90 transition font-bold border-4 border-verd-400">
  Ôºã
</button>

<!-- MODAL (Add/Edit) -->
<div id="modal" class="fixed inset-0 z-50 hidden">
  <div class="modal-overlay absolute inset-0" onclick="closeModal()"></div>
  <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl slide-up max-h-[92vh] overflow-y-auto">
    <div class="sticky top-0 bg-white rounded-t-3xl z-10 px-5 pt-4 pb-2 border-b border-gray-100">
      <div class="flex items-center justify-between">
        <h2 id="modalTitle" class="text-xl font-extrabold text-verd-700">Afegir producte</h2>
        <button onclick="closeModal()" class="text-3xl text-gray-400 hover:text-gray-600 px-2 active:scale-90 transition">‚úï</button>
      </div>
      <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mt-2"></div>
    </div>
    <form id="productForm" onsubmit="saveProduct(event)" class="px-5 py-4 space-y-4 pb-8">
      <input type="hidden" id="editId" value="">

      <div>
        <label class="block text-base font-bold text-gray-600 mb-1">Nom del producte *</label>
        <input id="fName" type="text" required placeholder="Ex: Oli de coco bio"
          class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-lg font-semibold focus:border-verd-500 focus:outline-none focus:ring-2 focus:ring-verd-200">
      </div>

      <div>
        <label class="block text-base font-bold text-gray-600 mb-1">Categoria *</label>
        <select id="fCategory" required
          class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-lg font-semibold focus:border-verd-500 focus:outline-none bg-white focus:ring-2 focus:ring-verd-200">
          <option value="">-- Tria categoria --</option>
          <option value="Alimentaci√≥">üçØ Alimentaci√≥</option>
          <option value="Cosm√®tica">üß¥ Cosm√®tica</option>
          <option value="Suplements">üíä Suplements</option>
          <option value="Infusions">üçµ Infusions</option>
          <option value="Higiene">üßº Higiene</option>
          <option value="Altres">üì¶ Altres</option>
        </select>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-base font-bold text-gray-600 mb-1">Quantitat *</label>
          <div class="flex items-center border-2 border-gray-200 rounded-xl overflow-hidden focus-within:border-verd-500 focus-within:ring-2 focus-within:ring-verd-200">
            <button type="button" onclick="adjustQty(-1)" class="px-4 py-3 text-2xl font-bold text-verd-700 bg-gray-50 hover:bg-gray-100 active:bg-gray-200 min-h-[52px]">‚àí</button>
            <input id="fQuantity" type="number" min="0" required value="1"
              class="w-full text-center text-xl font-bold border-0 focus:outline-none py-3">
            <button type="button" onclick="adjustQty(1)" class="px-4 py-3 text-2xl font-bold text-verd-700 bg-gray-50 hover:bg-gray-100 active:bg-gray-200 min-h-[52px]">Ôºã</button>
          </div>
        </div>
        <div>
          <label class="block text-base font-bold text-gray-600 mb-1">Caducitat</label>
          <input id="fExpiry" type="date"
            class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-lg font-semibold focus:border-verd-500 focus:outline-none focus:ring-2 focus:ring-verd-200">
        </div>
      </div>

      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-base font-bold text-gray-600 mb-1">Preu compra (‚Ç¨)</label>
          <input id="fPriceBuy" type="number" step="0.01" min="0" placeholder="0.00"
            class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-lg font-semibold focus:border-verd-500 focus:outline-none focus:ring-2 focus:ring-verd-200">
        </div>
        <div>
          <label class="block text-base font-bold text-gray-600 mb-1">Preu venda (‚Ç¨)</label>
          <input id="fPriceSell" type="number" step="0.01" min="0" placeholder="0.00"
            class="w-full border-2 border-gray-200 rounded-xl px-4 py-3 text-lg font-semibold focus:border-verd-500 focus:outline-none focus:ring-2 focus:ring-verd-200">
        </div>
      </div>

      <button type="submit" id="btnSave"
        class="w-full bg-verd-600 hover:bg-verd-500 text-white font-extrabold text-xl py-4 rounded-xl shadow-lg active:scale-95 transition btn-big mt-2">
        ‚úÖ Guardar producte
      </button>

      <button type="button" id="btnDelete" onclick="deleteProduct()" class="hidden w-full bg-red-500 hover:bg-red-600 text-white font-extrabold text-xl py-4 rounded-xl shadow-lg active:scale-95 transition btn-big">
        üóëÔ∏è Esborrar producte
      </button>
    </form>
  </div>
</div>

<!-- CONFIRM DELETE MODAL -->
<div id="confirmModal" class="fixed inset-0 z-[60] hidden">
  <div class="modal-overlay absolute inset-0" onclick="closeConfirm()"></div>
  <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl slide-up px-5 py-6 pb-10">
    <div class="text-center mb-5">
      <div class="text-5xl mb-3">‚ö†Ô∏è</div>
      <h3 class="text-xl font-extrabold text-gray-800">Segur que vols esborrar?</h3>
      <p id="confirmName" class="text-lg text-gray-500 mt-1 font-semibold"></p>
    </div>
    <div class="flex gap-3">
      <button onclick="closeConfirm()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-extrabold text-xl py-4 rounded-xl active:scale-95 transition btn-big">
        No, torna
      </button>
      <button onclick="confirmDelete()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-extrabold text-xl py-4 rounded-xl active:scale-95 transition btn-big">
        Si, esborra
      </button>
    </div>
  </div>
</div>

<!-- HISTORY MODAL -->
<div id="historyModal" class="fixed inset-0 z-[60] hidden">
  <div class="absolute inset-0 bg-black/50" onclick="closeHistory()"></div>
  <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-2xl max-h-[80vh] flex flex-col">
    <div class="p-4 border-b flex justify-between items-center shrink-0">
      <h2 class="font-extrabold text-xl text-verd-700">üìã Historial de moviments</h2>
      <button onclick="closeHistory()" class="text-2xl text-gray-400 w-10 h-10 flex items-center justify-center">&times;</button>
    </div>
    <div id="historyList" class="p-4 overflow-y-auto flex-1 space-y-1"></div>
  </div>
</div>

<!-- TOAST -->
<div id="toast" class="fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-2xl font-bold text-lg shadow-xl z-[70] hidden transition-opacity"></div>

<script>
const STORAGE_KEY = 'botigaCris_products';
const CAT_EMOJI = { 'Alimentaci√≥':'üçØ', 'Cosm√®tica':'üß¥', 'Suplements':'üíä', 'Infusions':'üçµ', 'Higiene':'üßº', 'Altres':'üì¶' };

let products = [];
let currentCategory = 'Totes';
let deleteTargetId = null;

// --- DATA ---
function loadProducts() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (raw) {
    products = JSON.parse(raw);
  } else {
    products = getDefaultProducts();
    saveToStorage();
  }
}

function saveToStorage() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(products));
}

const LOG_KEY = 'botigaCris_log';
function logMovement(productName, action, qtyBefore, qtyAfter, method) {
  const log = JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
  log.unshift({
    ts: new Date().toISOString(),
    product: productName,
    action: action,
    delta: qtyAfter - qtyBefore,
    qtyAfter: qtyAfter,
    method: method || 'manual'
  });
  if (log.length > 200) log.length = 200;
  localStorage.setItem(LOG_KEY, JSON.stringify(log));
}

function getDefaultProducts() {
  const today = new Date();
  const d = (days) => {
    const dt = new Date(today);
    dt.setDate(dt.getDate() + days);
    return dt.toISOString().split('T')[0];
  };
  return [
    { id: genId(), name: 'Oli de coco bio', category: 'Alimentaci√≥', quantity: 8, expiry: d(120), priceBuy: 4.50, priceSell: 8.95 },
    { id: genId(), name: 'Infusio de camamilla', category: 'Infusions', quantity: 15, expiry: d(200), priceBuy: 1.80, priceSell: 3.50 },
    { id: genId(), name: 'Crema facial aloe vera', category: 'Cosm√®tica', quantity: 2, expiry: d(25), priceBuy: 6.00, priceSell: 12.90 },
    { id: genId(), name: 'Quinoa eco 500g', category: 'Alimentaci√≥', quantity: 5, expiry: d(5), priceBuy: 3.20, priceSell: 5.95 },
    { id: genId(), name: 'Sabo de marsella', category: 'Higiene', quantity: 12, expiry: '', priceBuy: 2.10, priceSell: 4.50 },
    { id: genId(), name: 'Mel ecologica 1kg', category: 'Alimentaci√≥', quantity: 1, expiry: d(300), priceBuy: 7.00, priceSell: 13.50 },
  ];
}

function genId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
}

// --- EXPIRY HELPERS ---
function getExpiryStatus(expiry) {
  if (!expiry) return 'ok';
  const today = new Date(); today.setHours(0,0,0,0);
  const exp = new Date(expiry + 'T00:00:00');
  const diff = Math.ceil((exp - today) / (1000*60*60*24));
  if (diff < 0) return 'expired';
  if (diff <= 7) return 'critical';
  if (diff <= 30) return 'warning';
  return 'ok';
}

function formatDate(d) {
  if (!d) return '‚Äî';
  const parts = d.split('-');
  return parts[2] + '/' + parts[1] + '/' + parts[0];
}

function daysUntilExpiry(expiry) {
  if (!expiry) return null;
  const today = new Date(); today.setHours(0,0,0,0);
  const exp = new Date(expiry + 'T00:00:00');
  return Math.ceil((exp - today) / (1000*60*60*24));
}

// --- RENDER ---
function renderProducts() {
  const search = document.getElementById('searchInput').value.toLowerCase().trim();
  let filtered = products.filter(p => {
    if (currentCategory !== 'Totes' && p.category !== currentCategory) return false;
    if (search && !p.name.toLowerCase().includes(search)) return false;
    return true;
  });

  // Sort: expired/critical first, then warning, then rest
  filtered.sort((a, b) => {
    const order = { expired: 0, critical: 1, warning: 2, ok: 3 };
    const sa = order[getExpiryStatus(a.expiry)];
    const sb = order[getExpiryStatus(b.expiry)];
    if (sa !== sb) return sa - sb;
    return a.name.localeCompare(b.name, 'ca');
  });

  const list = document.getElementById('productList');
  const empty = document.getElementById('emptyState');

  if (filtered.length === 0) {
    list.innerHTML = '';
    empty.classList.remove('hidden');
  } else {
    empty.classList.add('hidden');
    list.innerHTML = filtered.map(p => renderCard(p)).join('');
  }

  updateSummary();
}

function renderCard(p) {
  const status = getExpiryStatus(p.expiry);
  const days = daysUntilExpiry(p.expiry);
  const lowStock = p.quantity <= 2;

  let borderColor = 'border-gray-100';
  let bgColor = 'bg-white';
  let expiryBadge = '';
  let nameClass = 'text-gray-800';

  if (status === 'expired') {
    borderColor = 'border-red-400';
    bgColor = 'bg-red-50';
    expiryBadge = `<span class="inline-block bg-red-700 text-white text-xs font-bold px-2 py-0.5 rounded-full ml-1">CADUCAT</span>`;
    nameClass = 'text-red-700 line-through';
  } else if (status === 'critical') {
    borderColor = 'border-red-300';
    bgColor = 'bg-red-50';
    expiryBadge = `<span class="inline-block bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full ml-1">${days} dies</span>`;
  } else if (status === 'warning') {
    borderColor = 'border-orange-300';
    bgColor = 'bg-orange-50';
    expiryBadge = `<span class="inline-block bg-orange-400 text-white text-xs font-bold px-2 py-0.5 rounded-full ml-1">${days} dies</span>`;
  }

  const stockWarning = lowStock ? `<span class="text-lg" title="Poc estoc!">‚ö†Ô∏è</span>` : '';

  const emoji = CAT_EMOJI[p.category] || 'üì¶';

  return `
    <div onclick="editProduct('${p.id}')" class="card-product ${bgColor} border-2 ${borderColor} rounded-2xl px-4 py-3 shadow-sm cursor-pointer">
      <div class="flex items-start justify-between gap-2">
        <div class="flex-1 min-w-0">
          <div class="flex items-center gap-1 flex-wrap">
            <span class="text-lg">${emoji}</span>
            <span class="font-extrabold text-lg ${nameClass} truncate">${escHtml(p.name)}</span>
            ${expiryBadge}
          </div>
          <div class="flex items-center gap-3 mt-1 text-sm text-gray-500 font-semibold flex-wrap">
            <span>${p.category}</span>
            ${p.expiry ? `<span>üìÖ ${formatDate(p.expiry)}</span>` : ''}
            ${p.priceSell ? `<span>üí∞ ${Number(p.priceSell).toFixed(2)}‚Ç¨</span>` : ''}
          </div>
        </div>
        <div class="flex flex-col items-center ml-2">
          <div class="flex items-center gap-1">
            ${stockWarning}
            <button onclick="event.stopPropagation();quickAdjust('${p.id}',-1)" class="quick-btn w-8 h-8 rounded-full bg-red-100 text-red-600 font-bold text-lg flex items-center justify-center">‚àí</button>
            <span class="text-2xl font-extrabold ${lowStock ? 'text-red-500' : 'text-verd-700'} w-10 text-center">${p.quantity}</span>
            <button onclick="event.stopPropagation();quickAdjust('${p.id}',1)" class="quick-btn w-8 h-8 rounded-full bg-green-100 text-green-600 font-bold text-lg flex items-center justify-center">+</button>
          </div>
          <span class="text-xs text-gray-400 font-bold">unitats</span>
        </div>
      </div>
    </div>
  `;
}

function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function updateSummary() {
  const total = products.length;
  let expiring = 0;
  let lowStock = 0;
  products.forEach(p => {
    const s = getExpiryStatus(p.expiry);
    if (s === 'expired' || s === 'critical' || s === 'warning') expiring++;
    if (p.quantity <= 2) lowStock++;
  });
  document.getElementById('sumTotal').textContent = total;
  document.getElementById('sumExpiring').textContent = expiring;
  document.getElementById('sumLowStock').textContent = lowStock;
}

// --- CATEGORY FILTER ---
function setCategory(cat) {
  currentCategory = cat;
  document.querySelectorAll('.cat-btn').forEach(btn => {
    if (btn.dataset.cat === cat) {
      btn.className = 'cat-btn px-4 py-2 rounded-full font-bold text-base border-2 border-verd-600 bg-verd-600 text-white min-h-[44px] active:scale-95 transition';
    } else {
      btn.className = 'cat-btn px-4 py-2 rounded-full font-bold text-base border-2 border-verd-300 text-verd-700 bg-verd-50 min-h-[44px] active:scale-95 transition';
    }
  });
  renderProducts();
}

// --- MODAL ---
function openModal(id) {
  document.getElementById('modal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  if (id) {
    const p = products.find(x => x.id === id);
    if (!p) return;
    document.getElementById('modalTitle').textContent = 'Editar producte';
    document.getElementById('editId').value = p.id;
    document.getElementById('fName').value = p.name;
    document.getElementById('fCategory').value = p.category;
    document.getElementById('fQuantity').value = p.quantity;
    document.getElementById('fExpiry').value = p.expiry || '';
    document.getElementById('fPriceBuy').value = p.priceBuy || '';
    document.getElementById('fPriceSell').value = p.priceSell || '';
    document.getElementById('btnSave').textContent = '‚úÖ Guardar canvis';
    document.getElementById('btnDelete').classList.remove('hidden');
  } else {
    document.getElementById('modalTitle').textContent = 'Afegir producte';
    document.getElementById('editId').value = '';
    document.getElementById('productForm').reset();
    document.getElementById('fQuantity').value = 1;
    document.getElementById('btnSave').textContent = '‚úÖ Guardar producte';
    document.getElementById('btnDelete').classList.add('hidden');
  }
}

function closeModal() {
  document.getElementById('modal').classList.add('hidden');
  document.body.style.overflow = '';
}

function editProduct(id) {
  openModal(id);
}

function adjustQty(delta) {
  const input = document.getElementById('fQuantity');
  let val = parseInt(input.value) || 0;
  val = Math.max(0, val + delta);
  input.value = val;
}

// --- SAVE ---
function saveProduct(e) {
  e.preventDefault();
  const id = document.getElementById('editId').value;
  const data = {
    id: id || genId(),
    name: document.getElementById('fName').value.trim(),
    category: document.getElementById('fCategory').value,
    quantity: parseInt(document.getElementById('fQuantity').value) || 0,
    expiry: document.getElementById('fExpiry').value || '',
    priceBuy: parseFloat(document.getElementById('fPriceBuy').value) || 0,
    priceSell: parseFloat(document.getElementById('fPriceSell').value) || 0,
  };

  if (id) {
    const idx = products.findIndex(p => p.id === id);
    if (idx !== -1) {
      const oldQty = products[idx].quantity;
      products[idx] = data;
      if (data.quantity !== oldQty) {
        logMovement(data.name, data.quantity > oldQty ? 'entrada' : 'sortida', oldQty, data.quantity);
      }
    }
    showToast('Producte actualitzat ‚úÖ');
  } else {
    products.push(data);
    logMovement(data.name, 'nou', 0, data.quantity);
    showToast('Producte afegit ‚úÖ');
  }

  saveToStorage();
  closeModal();
  renderProducts();
}

// --- DELETE ---
function deleteProduct() {
  const id = document.getElementById('editId').value;
  if (!id) return;
  const p = products.find(x => x.id === id);
  deleteTargetId = id;
  document.getElementById('confirmName').textContent = p ? p.name : '';
  document.getElementById('confirmModal').classList.remove('hidden');
}

function confirmDelete() {
  if (deleteTargetId) {
    const dp = products.find(x => x.id === deleteTargetId);
    if (dp) logMovement(dp.name, 'eliminat', dp.quantity, 0);
    products = products.filter(p => p.id !== deleteTargetId);
    saveToStorage();
    showToast('Producte esborrat üóëÔ∏è');
    deleteTargetId = null;
  }
  closeConfirm();
  closeModal();
  renderProducts();
}

function closeConfirm() {
  document.getElementById('confirmModal').classList.add('hidden');
  deleteTargetId = null;
}

// --- TOAST ---
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.remove('hidden');
  t.style.opacity = '1';
  setTimeout(() => {
    t.style.opacity = '0';
    setTimeout(() => t.classList.add('hidden'), 300);
  }, 2000);
}

// --- CSV EXPORT ---
function exportCSV() {
  if (products.length === 0) { showToast('No hi ha productes per exportar'); return; }
  const headers = ['Nom','Categoria','Quantitat','Caducitat','Preu Compra','Preu Venda'];
  const rows = products.map(p => [
    '"' + p.name.replace(/"/g, '""') + '"',
    p.category,
    p.quantity,
    p.expiry || '',
    p.priceBuy || '',
    p.priceSell || ''
  ]);
  const csv = [headers.join(';'), ...rows.map(r => r.join(';'))].join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const date = new Date().toISOString().split('T')[0];
  a.href = url;
  a.download = `inventari_botigaCris_${date}.csv`;
  a.click();
  URL.revokeObjectURL(url);
  showToast('Arxiu CSV exportat üì§');
}

// --- CSV IMPORT ---
function importCSV(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const text = e.target.result;
      const lines = text.split('\n').filter(l => l.trim());
      if (lines.length < 2) { showToast('Arxiu buit o inv√†lid'); return; }

      const imported = [];
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(';').map(c => c.replace(/^"|"$/g, '').trim());
        if (cols.length < 2) continue;
        imported.push({
          id: genId(),
          name: cols[0] || 'Sense nom',
          category: cols[1] || 'Altres',
          quantity: parseInt(cols[2]) || 0,
          expiry: cols[3] || '',
          priceBuy: parseFloat(cols[4]) || 0,
          priceSell: parseFloat(cols[5]) || 0,
        });
      }

      if (imported.length === 0) { showToast('Cap producte trobat a l\'arxiu'); return; }

      products = imported;
      saveToStorage();
      renderProducts();
      showToast(`${imported.length} productes importats üì•`);
    } catch (err) {
      showToast('Error llegint l\'arxiu');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// --- QUICK STOCK ADJUSTMENT ---
function quickAdjust(id, delta) {
  const p = products.find(x => x.id === id);
  if (!p) return;
  const oldQty = p.quantity;
  p.quantity = Math.max(0, p.quantity + delta);
  if (p.quantity !== oldQty) {
    logMovement(p.name, delta > 0 ? 'entrada' : 'sortida', oldQty, p.quantity, 'r√†pid');
    saveToStorage();
    renderProducts();
  }
}

// --- EXPIRY ALERTS ---
function checkExpiryAlerts() {
  if (sessionStorage.getItem('expiryAlertDismissed')) return;
  const alerts = [];
  products.forEach(p => {
    if (!p.expiry) return;
    const days = daysUntilExpiry(p.expiry);
    if (days !== null && days <= 7) alerts.push({ name: p.name, days });
  });
  if (alerts.length === 0) return;
  alerts.sort((a, b) => a.days - b.days);

  let html = '<div id="expiryAlert" class="mx-3 mt-2 bg-orange-50 border-2 border-orange-300 rounded-2xl p-3 relative">';
  html += '<button onclick="dismissExpiryAlert()" class="absolute top-2 right-3 text-gray-400 hover:text-gray-600 text-xl font-bold leading-none">&times;</button>';
  html += '<div class="font-extrabold text-orange-700 text-sm mb-1">Alerta de caducitat</div>';
  alerts.forEach(a => {
    if (a.days < 0) {
      html += `<div class="text-sm"><span class="font-bold text-red-600">${escHtml(a.name)}</span> ‚Äî CADUCAT fa ${Math.abs(a.days)} dies</div>`;
    } else if (a.days === 0) {
      html += `<div class="text-sm"><span class="font-bold text-red-600">${escHtml(a.name)}</span> ‚Äî Caduca AVUI</div>`;
    } else {
      html += `<div class="text-sm"><span class="font-bold text-orange-700">${escHtml(a.name)}</span> ‚Äî ${a.days} dies</div>`;
    }
  });
  html += '</div>';
  document.getElementById('summaryBar').insertAdjacentHTML('afterend', html);
}

function dismissExpiryAlert() {
  const el = document.getElementById('expiryAlert');
  if (el) el.remove();
  sessionStorage.setItem('expiryAlertDismissed', '1');
}

// --- HISTORY ---
function showHistory() {
  const log = JSON.parse(localStorage.getItem(LOG_KEY) || '[]');
  const list = document.getElementById('historyList');
  if (log.length === 0) {
    list.innerHTML = '<p class="text-center text-gray-400 py-8">Encara no hi ha moviments</p>';
  } else {
    list.innerHTML = log.map(e => {
      const d = new Date(e.ts);
      const time = d.toLocaleDateString('ca', {day:'2-digit',month:'2-digit'}) + ' ' + d.toLocaleTimeString('ca', {hour:'2-digit',minute:'2-digit'});
      const delta = e.delta > 0 ? `+${e.delta}` : `${e.delta}`;
      const color = e.delta > 0 ? 'text-green-600' : e.delta < 0 ? 'text-red-600' : 'text-gray-500';
      const icon = e.action === 'entrada' ? 'üì•' : e.action === 'sortida' ? 'üì§' : e.action === 'eliminat' ? 'üóëÔ∏è' : e.action === 'nou' ? 'üÜï' : 'üìù';
      const badge = e.method === 'veu' ? ' <span class="text-xs bg-purple-100 text-purple-700 px-1.5 rounded-full font-bold">veu</span>' : '';
      return `<div class="flex items-center gap-2 py-2 border-b border-gray-100">
        <span class="text-lg">${icon}</span>
        <div class="flex-1 min-w-0">
          <div class="font-bold text-sm truncate">${escHtml(e.product)}</div>
          <div class="text-xs text-gray-400">${time}${badge}</div>
        </div>
        <div class="text-right">
          <span class="font-extrabold ${color}">${delta}</span>
          <div class="text-xs text-gray-400">${e.qtyAfter ?? ''} un.</div>
        </div>
      </div>`;
    }).join('');
  }
  document.getElementById('historyModal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeHistory() {
  document.getElementById('historyModal').classList.add('hidden');
  document.body.style.overflow = '';
}

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
  loadProducts();
  renderProducts();
  checkExpiryAlerts();
});

// ==========================================
// VOICE INPUT FEATURE
// ==========================================

const VoiceState = { IDLE: 'idle', LISTENING: 'listening', PROCESSING: 'processing', SUCCESS: 'success', ERROR: 'error' };
let voiceState = VoiceState.IDLE;
let recognition = null;
let voiceSpeechSupported = false;

// Number words in Catalan
const CATALAN_NUMBERS = {
  'zero':0,'un':1,'una':1,'dos':2,'dues':2,'tres':3,'quatre':4,'cinc':5,'sis':6,'set':7,'vuit':8,'nou':9,
  'deu':10,'onze':11,'dotze':12,'tretze':13,'catorze':14,'quinze':15,'setze':16,'disset':17,'divuit':18,'dinou':19,
  'vint':20,'vint-i-un':21,'vint-i-una':21,'vint-i-dos':22,'vint-i-dues':22,'vint-i-tres':23,'vint-i-quatre':24,
  'vint-i-cinc':25,'vint-i-sis':26,'vint-i-set':27,'vint-i-vuit':28,'vint-i-nou':29,
  'trenta':30,'quaranta':40,'cinquanta':50,'seixanta':60,'setanta':70,'vuitanta':80,'noranta':90,'cent':100,
  'dos-cents':200,'tres-cents':300,'quatre-cents':400,'cinc-cents':500,
  'mil':1000,'dos mil':2000
};

const CATALAN_MONTHS = {
  'gener':1,'febrer':2,'marc':3,'mar√ß':3,'abril':4,'maig':5,'juny':6,
  'juliol':7,'agost':8,'setembre':9,'octubre':10,'novembre':11,'desembre':12
};

const CATEGORIES = ['Alimentaci√≥','Cosm√®tica','Suplements','Infusions','Higiene','Altres'];
const CATEGORY_KEYWORDS = {
  'alimentaci√≥':'Alimentaci√≥','alimentacio':'Alimentaci√≥','menjar':'Alimentaci√≥',
  'xocolata':'Alimentaci√≥','mel':'Alimentaci√≥','pa':'Alimentaci√≥','arr√≤s':'Alimentaci√≥','arros':'Alimentaci√≥','farina':'Alimentaci√≥','oli':'Alimentaci√≥',
  'cosm√®tica':'Cosm√®tica','cosmetica':'Cosm√®tica','crema':'Cosm√®tica',
  'suplements':'Suplements','suplement':'Suplements','vitamina':'Suplements',
  'infusions':'Infusions','infusi√≥':'Infusions','infusio':'Infusions','te':'Infusions','camamilla':'Infusions',
  'higiene':'Higiene','sab√≥':'Higiene','sabo':'Higiene',
  'altres':'Altres'
};

function initVoice() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) {
    document.getElementById('micFab').style.display = 'none';
    return;
  }
  voiceSpeechSupported = true;
  recognition = new SpeechRecognition();
  recognition.lang = 'ca-ES';
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.maxAlternatives = 1;

  let accumulatedFinal = '';
  let currentInterim = '';
  let silenceTimer = null;
  let maxSessionTimer = null;

  function clearVoiceTimers() {
    clearTimeout(silenceTimer);
    clearTimeout(maxSessionTimer);
  }

  function resetSilenceTimer() {
    clearTimeout(silenceTimer);
    silenceTimer = setTimeout(() => {
      if (voiceState === VoiceState.LISTENING) {
        try { recognition.stop(); } catch(e) {}
      }
    }, 4000);
  }

  recognition.onstart = () => {
    accumulatedFinal = '';
    currentInterim = '';
    setVoiceState(VoiceState.LISTENING);
    resetSilenceTimer();
    clearTimeout(maxSessionTimer);
    maxSessionTimer = setTimeout(() => {
      if (voiceState === VoiceState.LISTENING) {
        try { recognition.stop(); } catch(e) {}
      }
    }, 30000);
  };

  recognition.onresult = (event) => {
    accumulatedFinal = '';
    currentInterim = '';
    for (let i = 0; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        accumulatedFinal += transcript + ' ';
      } else {
        currentInterim += transcript;
      }
    }
    const display = (accumulatedFinal + currentInterim).trim();
    document.getElementById('voiceText').textContent = display;
    resetSilenceTimer();
  };

  recognition.onerror = (event) => {
    clearVoiceTimers();
    if (event.error === 'not-allowed') {
      showVoiceError('Perm√≠s de micr√≤fon denegat. Activa\'l a la configuraci√≥ del navegador.');
    } else if (event.error === 'no-speech') {
      showVoiceError('No s\'ha detectat cap veu. Torna a provar.');
    } else if (event.error === 'aborted') {
      setVoiceState(VoiceState.IDLE);
      hideVoiceOverlay();
    } else {
      showVoiceError('Error: ' + event.error);
    }
  };

  recognition.onend = () => {
    clearVoiceTimers();
    const fullText = (accumulatedFinal + currentInterim).trim();
    accumulatedFinal = '';
    currentInterim = '';

    if (voiceState !== VoiceState.LISTENING) return;

    if (fullText) {
      try {
        processVoiceCommand(fullText.toLowerCase());
      } catch(e) {
        showVoiceError('Error processant: ' + e.message);
      }
    } else {
      setVoiceState(VoiceState.IDLE);
      hideVoiceOverlay();
    }
  };
}

function toggleVoice() {
  if (!voiceSpeechSupported) {
    showToast('El teu navegador no suporta la veu');
    return;
  }
  if (voiceState === VoiceState.LISTENING) {
    // Stop recognition ‚Äî onend will process accumulated text
    try { recognition.stop(); } catch(e) {}
  } else if (voiceState === VoiceState.IDLE) {
    startListening();
  }
}

function startListening() {
  document.getElementById('voiceText').textContent = '';
  document.getElementById('voiceParsed').textContent = '';
  document.getElementById('voiceDots').style.display = '';
  document.getElementById('voiceStatus').textContent = 'Escoltant...';
  document.getElementById('voiceStatus').style.color = '#a78bfa';
  showVoiceOverlay();
  try {
    recognition.start();
  } catch (e) {
    showVoiceError('No s\'ha pogut iniciar el micr√≤fon.');
  }
}

function setVoiceState(state) {
  voiceState = state;
  const btn = document.getElementById('micFab');
  const icons = { mic: 'micIcon', stop: 'micIconStop', check: 'micIconCheck', x: 'micIconX' };
  Object.values(icons).forEach(id => document.getElementById(id).style.display = 'none');
  btn.classList.remove('listening', 'processing', 'success', 'error');

  switch (state) {
    case VoiceState.IDLE:
      document.getElementById('micIcon').style.display = '';
      break;
    case VoiceState.LISTENING:
      btn.classList.add('listening');
      document.getElementById('micIconStop').style.display = '';
      break;
    case VoiceState.PROCESSING:
      btn.classList.add('processing');
      document.getElementById('micIcon').style.display = '';
      break;
    case VoiceState.SUCCESS:
      btn.classList.add('success');
      document.getElementById('micIconCheck').style.display = '';
      setTimeout(() => { if (voiceState === VoiceState.SUCCESS) setVoiceState(VoiceState.IDLE); }, 2000);
      break;
    case VoiceState.ERROR:
      btn.classList.add('error');
      document.getElementById('micIconX').style.display = '';
      setTimeout(() => { if (voiceState === VoiceState.ERROR) setVoiceState(VoiceState.IDLE); }, 2500);
      break;
  }
}

function showVoiceOverlay() {
  document.getElementById('voiceOverlay').classList.add('visible');
}

function hideVoiceOverlay() {
  document.getElementById('voiceOverlay').classList.remove('visible');
}

function showVoiceError(msg) {
  setVoiceState(VoiceState.ERROR);
  document.getElementById('voiceStatus').textContent = msg;
  document.getElementById('voiceStatus').style.color = '#f87171';
  document.getElementById('voiceDots').style.display = 'none';
  setTimeout(() => { hideVoiceOverlay(); }, 3000);
}

function showVoiceSuccess(msg) {
  setVoiceState(VoiceState.SUCCESS);
  document.getElementById('voiceStatus').textContent = msg;
  document.getElementById('voiceStatus').style.color = '#4ade80';
  document.getElementById('voiceDots').style.display = 'none';
  setTimeout(() => { setVoiceState(VoiceState.IDLE); hideVoiceOverlay(); }, 2000);
}


// --- PARSING ---

// Normalize speech-to-text variations before parsing
function normalizeVoiceText(text) {
  let t = text.toLowerCase().trim();
  t = t.replace(/\s+/g, ' ');
  // "vint i tres" ‚Üí "vint-i-tres"
  t = t.replace(/\bvint\s+i\s+(un|una|dos|dues|tres|quatre|cinc|sis|set|vuit|nou)\b/g, 'vint-i-$1');
  // "trenta-i-cinc" ‚Üí "trenta-cinc" (remove spurious -i- for 30+)
  t = t.replace(/\b(trenta|quaranta|cinquanta|seixanta|setanta|vuitanta|noranta)-i-(un|una|dos|dues|tres|quatre|cinc|sis|set|vuit|nou)\b/g, '$1-$2');
  // "trenta cinc" or "trenta i cinc" ‚Üí "trenta-cinc"
  t = t.replace(/\b(trenta|quaranta|cinquanta|seixanta|setanta|vuitanta|noranta)\s+i?\s*(un|una|dos|dues|tres|quatre|cinc|sis|set|vuit|nou)\b/g, '$1-$2');
  // "cinc cents" ‚Üí "cinc-cents"
  t = t.replace(/\b(dos|tres|quatre|cinc|sis|set|vuit|nou)\s+cents?\b/g, '$1-cents');
  // Contractions: "vintitr√®s" ‚Üí "vint-i-tres"
  t = t.replace(/\bvinti(\w+)/g, 'vint-i-$1');
  // Strip accents from number-word positions (tr√®s ‚Üí tres, sis ‚Üí sis)
  t = t.replace(/\bvint-i-(\w+)/g, (m, p1) => 'vint-i-' + p1.normalize('NFD').replace(/[\u0300-\u036f]/g, ''));
  return t;
}

const WEIGHT_UNITS_RE = /^(?:grams?|quilos?|quilograms?|litres?|mil[¬∑.]?lilitres?|millilitres?|kg|g|ml|l|cl)$/i;

function parseNumberWord(text) {
  if (!text) return null;
  let t = text.toLowerCase().trim();

  // Direct digit
  if (/^\d+$/.test(t)) return parseInt(t);

  // Normalize hyphens/spaces for number matching
  t = normalizeVoiceText(t);

  // Direct dictionary lookup
  if (CATALAN_NUMBERS[t] !== undefined) return CATALAN_NUMBERS[t];

  // "dos mil X" ‚Üí 2000 + X
  const dosMilMatch = t.match(/^dos\s+mil\s*(.*)$/);
  if (dosMilMatch) {
    const rest = dosMilMatch[1].trim();
    if (!rest) return 2000;
    const restNum = parseNumberWord(rest);
    return restNum !== null ? 2000 + restNum : 2000;
  }

  // "mil X" ‚Üí 1000 + X
  if (/^mil\b/.test(t)) {
    const rest = t.substring(3).trim();
    if (!rest) return 1000;
    const restNum = parseNumberWord(rest);
    return restNum !== null ? 1000 + restNum : 1000;
  }

  // "cent X" ‚Üí 100 + X
  if (/^cent\b/.test(t)) {
    const rest = t.substring(4).trim();
    if (!rest) return 100;
    const restNum = parseNumberWord(rest);
    return restNum !== null ? 100 + restNum : 100;
  }

  // Compound with one hyphen: "trenta-cinc" ‚Üí 30 + 5
  const compoundMatch = t.match(/^(\w+)-(\w+)$/);
  if (compoundMatch) {
    const a = CATALAN_NUMBERS[compoundMatch[1]];
    const b = CATALAN_NUMBERS[compoundMatch[2]];
    if (a !== undefined && b !== undefined) return a + b;
  }

  // Fallback: longest matching dictionary entry with word boundaries
  const sortedEntries = Object.entries(CATALAN_NUMBERS).sort((a, b) => b[0].length - a[0].length);
  for (const [word, num] of sortedEntries) {
    const escaped = word.replace(/[-]/g, '[-\\s]').replace(/\s+/g, '\\s+');
    const re = new RegExp('(?:^|\\s)' + escaped + '(?:\\s|$)');
    if (re.test(t)) return num;
  }

  // Last resort: extract embedded digit
  const anyDigit = t.match(/\b(\d+)\b/);
  if (anyDigit) return parseInt(anyDigit[1]);

  return null;
}

function extractQuantity(text) {
  // Zone before expiry keywords to avoid confusing date numbers with quantity
  let zone = text;
  const caducaIdx = text.search(/\b(?:que\s+)?(?:caduca|caduqui|de\s+caducitat|caducitat)\b/i);
  if (caducaIdx > 0) zone = text.substring(0, caducaIdx);

  // Remove digit-based weight measures
  let clean = zone.replace(/\b\d+\s*(?:grams?|quilos?|quilograms?|litres?|mil[¬∑.]?lilitres?|millilitres?|kg|g|ml|l|cl)\b/gi, '');

  // Remove ALL Catalan number words followed by weight units (not just hundreds)
  const weightUnitPat = '(?:grams?|quilos?|quilograms?|litres?|mil[¬∑.]?lilitres?|millilitres?|kg|g|ml|l|cl)';
  const allNumWords = Object.keys(CATALAN_NUMBERS).sort((a, b) => b.length - a.length);
  for (const nw of allNumWords) {
    const escaped = nw.replace(/[-]/g, '[-\\s]').replace(/\s+/g, '\\s+');
    const re = new RegExp('\\b' + escaped + '\\s+' + weightUnitPat + '\\b', 'gi');
    clean = clean.replace(re, '');
  }

  // "a X unitats" pattern (e.g. "actualitza vitamina c a deu unitats")
  const aUnitatMatch = clean.match(/\ba\s+([\w][\w\s-]*?)\s+unitats?\b/i);
  if (aUnitatMatch) {
    const n = parseNumberWord(aUnitatMatch[1]);
    if (n !== null) return n;
  }

  // Catalan number word + unitats
  const unitatMatch = clean.match(/([\w][\w\s-]*?)\s+unitats?\b/i);
  if (unitatMatch) {
    const n = parseNumberWord(unitatMatch[1]);
    if (n !== null) return n;
  }

  // Digit + unitats
  const digitUnitat = clean.match(/(\d+)\s*unitats?\b/i);
  if (digitUnitat) return parseInt(digitUnitat[1]);

  // "una"/"un" as quantity
  if (/\buna\b/i.test(clean)) return 1;
  if (/^(?:afegeix|afegir|treu|actualitza)\s+un\b/i.test(text)) return 1;

  // Standalone digit NOT before weight unit
  const digit = clean.match(/\b(\d+)\b(?!\s*(?:grams?|quilos?|kg|g|ml|l|cl)\b)/i);
  if (digit) return parseInt(digit[1]);

  // Leading number word after action ‚Äî only if NOT followed by a weight unit
  const afterAction = clean.replace(/^(?:afegeix|afegir|treu|actualitza)\s+(?:una?\s+)?/i, '').trim();
  const leadingMatch = afterAction.match(/^([\w]+(?:-[\w]+)*)\b/);
  if (leadingMatch) {
    const candidate = leadingMatch[1];
    const rest = afterAction.substring(candidate.length).trim();
    const nextWord = (rest.match(/^(\S+)/) || [])[1] || '';
    if (!WEIGHT_UNITS_RE.test(nextWord)) {
      const n = parseNumberWord(candidate);
      if (n !== null && n > 0 && n <= 99) return n;
    }
  }

  return 1;
}

function extractExpiry(text) {
  const expiryPattern = /(?:que\s+)?(?:caduca|caduqui|de\s+caducitat|caducitat)\s+(?:el\s+|l')?(.+)/i;
  const m = text.match(expiryPattern);
  if (!m) return '';
  return parseCatalanDate(m[1].trim());
}

function parseCatalanDate(text) {
  let day = null, month = null, year = null;

  // Find month FIRST to anchor day/year extraction
  let monthPos = -1;
  for (const [monthName, monthNum] of Object.entries(CATALAN_MONTHS)) {
    const idx = text.indexOf(monthName);
    if (idx !== -1) { month = monthNum; monthPos = idx; break; }
  }
  if (!month) return '';

  // Extract day from text BEFORE the month (avoids grabbing year numbers)
  const beforeMonth = text.substring(0, monthPos).replace(/\s+de?\s*$/i, '').replace(/\s+d['']?\s*$/i, '').trim();
  const dayDigit = beforeMonth.match(/(\d{1,2})/);
  if (dayDigit) {
    day = parseInt(dayDigit[1]);
  } else if (beforeMonth) {
    day = parseNumberWord(beforeMonth);
  }
  if (!day || day < 1 || day > 31) return '';

  // Extract year from text AFTER the month
  const afterMonth = text.substring(monthPos);
  const yearDigit = afterMonth.match(/\b(20\d{2})\b/);
  if (yearDigit) {
    year = parseInt(yearDigit[1]);
  } else {
    const ym = afterMonth.match(/(?:del?\s+)?dos\s+mil\s+([\w\s-]+)/i);
    if (ym) {
      const yearRest = parseNumberWord(ym[1].trim());
      if (yearRest !== null) year = 2000 + yearRest;
    }
  }

  if (!year) {
    const now = new Date();
    year = now.getFullYear();
    const testDate = new Date(year, month - 1, day);
    if (testDate < now) year++;
  }

  return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
}

function extractCategory(text) {
  const lower = text.toLowerCase();
  for (const [keyword, cat] of Object.entries(CATEGORY_KEYWORDS)) {
    const re = new RegExp('\\b' + keyword.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '\\b', 'i');
    if (re.test(lower)) return cat;
  }
  return '';
}

function extractAction(text) {
  if (/\b(?:treu|treure)\b/.test(text)) return 'remove';
  if (/\b(?:actualitza|actualitzar)\b/.test(text)) return 'update';
  return 'add';
}

function extractProductName(text) {
  let cleaned = text;

  // Remove action words at the start
  cleaned = cleaned.replace(/^(afegeix|afegir|afegei|actualitza|actualitzar|treu|treure)\s+/i, '');

  // Remove leading "una"/"un"
  cleaned = cleaned.replace(/^una?\s+/i, '');

  // Remove leading quantity number word ‚Äî but NOT if followed by a weight unit
  const leadingNumMatch = cleaned.match(/^([\w]+(?:-[\w]+)*)\s+/);
  if (leadingNumMatch) {
    const candidate = leadingNumMatch[1];
    const afterNum = cleaned.substring(leadingNumMatch[0].length);
    const nextWord = (afterNum.match(/^(\S+)/) || [])[1] || '';
    const isNum = parseNumberWord(candidate);
    if (isNum !== null && !WEIGHT_UNITS_RE.test(nextWord)) {
      cleaned = afterNum;
    }
  }

  // Remove "a X unitats" pattern
  cleaned = cleaned.replace(/\ba\s+[\w-]+\s+unitats?\b/gi, '');
  // Remove "X unitats" (digits)
  cleaned = cleaned.replace(/\b\d+\s*unitats?\b/gi, '');
  // Remove Catalan number word + unitats
  const sortedNums = Object.keys(CATALAN_NUMBERS).sort((a, b) => b.length - a.length);
  for (const word of sortedNums) {
    const escaped = word.replace(/[-]/g, '[-\\s]').replace(/\s+/g, '\\s+');
    const re = new RegExp('\\b' + escaped + '\\s+unitats?\\b', 'gi');
    cleaned = cleaned.replace(re, '');
  }

  // Remove expiry phrases
  cleaned = cleaned.replace(/(?:que\s+)?(?:caduca|caduqui|de\s+caducitat|caducitat)\s+.*/i, '');

  // Remove category mentions at the end
  cleaned = cleaned.replace(/\s+(?:categoria|de la categoria)\s+\w+\s*$/i, '');

  // Clean up
  cleaned = cleaned.replace(/,\s*\d+\s*/g, ',');
  cleaned = cleaned.replace(/\s+/g, ' ').trim();
  cleaned = cleaned.replace(/^[,\s]+|[,\s]+$/g, '').trim();

  // Remove orphan trailing prepositions/articles
  cleaned = cleaned.replace(/\s+(de|del|de la|de les|a|al|el|la|les|els|un|una|uns|unes)\s*$/i, '').trim();
  // Remove orphan leading articles
  cleaned = cleaned.replace(/^(el|la|les|els)\s+/i, '').trim();

  return cleaned;
}

function findExistingProduct(name) {
  if (!name) return null;
  const lower = name.toLowerCase();

  // Exact match
  let found = products.find(p => p.name.toLowerCase() === lower);
  if (found) return found;

  // Contains match
  found = products.find(p => p.name.toLowerCase().includes(lower) || lower.includes(p.name.toLowerCase()));
  if (found) return found;

  // Fuzzy: check if 70%+ of words match
  const words = lower.split(/\s+/);
  if (words.length >= 2) {
    let bestMatch = null;
    let bestScore = 0;
    for (const p of products) {
      const pWords = p.name.toLowerCase().split(/\s+/);
      let matchCount = 0;
      for (const w of words) {
        if (pWords.some(pw => pw.includes(w) || w.includes(pw))) matchCount++;
      }
      const score = matchCount / Math.max(words.length, pWords.length);
      if (score > bestScore && score >= 0.5) {
        bestScore = score;
        bestMatch = p;
      }
    }
    if (bestMatch) return bestMatch;
  }

  return null;
}

function processVoiceCommand(text) {
  text = normalizeVoiceText(text);
  setVoiceState(VoiceState.PROCESSING);
  document.getElementById('voiceStatus').textContent = 'Processant...';
  document.getElementById('voiceStatus').style.color = '#a78bfa';
  document.getElementById('voiceDots').style.display = 'none';

  const action = extractAction(text);
  const quantity = extractQuantity(text);
  const expiry = extractExpiry(text);
  const category = extractCategory(text);
  const productName = extractProductName(text);

  if (!productName || productName.length < 2) {
    document.getElementById('voiceParsed').innerHTML = '<span style="color:#fbbf24">No s\'ha pogut entendre el producte. Torna a provar.</span><br><span style="color:#9ca3af;font-size:12px">He sentit: "' + escHtml(text) + '"</span>';
    showVoiceError('No he ent√®s el producte. Torna a provar.');
    return;
  }

  // Show parsed result
  let parsedInfo = '<strong>' + escHtml(productName) + '</strong>';
  parsedInfo += ' &mdash; ' + quantity + ' unitat' + (quantity !== 1 ? 's' : '');
  if (expiry) parsedInfo += ' &mdash; Cad: ' + formatDate(expiry);
  if (category) parsedInfo += ' &mdash; ' + category;
  document.getElementById('voiceParsed').innerHTML = parsedInfo;

  const existing = findExistingProduct(productName);

  let confirmMsg = '';

  if (action === 'remove') {
    if (existing) {
      const oldQty = existing.quantity;
      existing.quantity = Math.max(0, existing.quantity - quantity);
      logMovement(existing.name, 'sortida', oldQty, existing.quantity, 'veu');
      saveToStorage();
      renderProducts();
      confirmMsg = 'Tret: ' + existing.name + ', ' + quantity + ' unitat' + (quantity !== 1 ? 's' : '') + '. Queden ' + existing.quantity;
      showToast(confirmMsg);
    } else {
      showVoiceError('No he trobat "' + productName + '" a l\'inventari.');
      return;
    }
  } else if (action === 'update') {
    if (existing) {
      const oldQty = existing.quantity;
      existing.quantity = quantity;
      if (expiry) existing.expiry = expiry;
      if (category) existing.category = category;
      logMovement(existing.name, 'ajust', oldQty, existing.quantity, 'veu');
      saveToStorage();
      renderProducts();
      confirmMsg = 'Actualitzat: ' + existing.name + ' a ' + quantity + ' unitat' + (quantity !== 1 ? 's' : '');
      showToast(confirmMsg);
    } else {
      showVoiceError('No he trobat "' + productName + '" a l\'inventari.');
      return;
    }
  } else {
    // Add
    if (existing) {
      const oldQty = existing.quantity;
      existing.quantity += quantity;
      if (expiry && !existing.expiry) existing.expiry = expiry;
      logMovement(existing.name, 'entrada', oldQty, existing.quantity, 'veu');
      saveToStorage();
      renderProducts();
      confirmMsg = 'Afegit: ' + existing.name + ' +' + quantity + ' (total: ' + existing.quantity + ')';
      showToast(confirmMsg);
    } else {
      const newProduct = {
        id: genId(),
        name: productName.charAt(0).toUpperCase() + productName.slice(1),
        category: category || 'Altres',
        quantity: quantity,
        expiry: expiry || '',
        priceBuy: 0,
        priceSell: 0,
      };
      products.push(newProduct);
      logMovement(newProduct.name, 'nou', 0, quantity, 'veu');
      saveToStorage();
      renderProducts();
      confirmMsg = 'Afegit: ' + newProduct.name + ' - ' + quantity + ' unitat' + (quantity !== 1 ? 's' : '');
      showToast(confirmMsg);
    }
  }

  // Speech synthesis confirmation
  speakCatalan(confirmMsg);
  showVoiceSuccess(confirmMsg);
}

// --- TEMPORARY TEST FUNCTION (delete after validation) ---
function testVoiceParsing() {
  const tests = [
    { input: "afegeix una barra de xocolata de cinc-cents grams que caduqui el vint-i-tres de mar√ß del dos mil vint-i-vuit",
      expected: { action: 'add', product: 'barra de xocolata de cinc-cents grams', qty: 1, expiry: '2028-03-23' } },
    { input: "afegeix tres paquets de te verd que caduca el quinze de juny",
      expected: { action: 'add', product: 'paquets de te verd', qty: 3 } },
    { input: "treu dos crema hidratant",
      expected: { action: 'remove', product: 'crema hidratant', qty: 2 } },
    { input: "actualitza vitamina c a deu unitats",
      expected: { action: 'update', product: 'vitamina c', qty: 10 } },
    { input: "sab√≥ de lavanda caducitat tretze de setembre del dos mil vint-i-sis",
      expected: { action: 'add', product: 'sab√≥ de lavanda', qty: 1, expiry: '2026-09-13' } },
    { input: "afegeix cinc quilos de mel",
      expected: { action: 'add', product: 'cinc quilos de mel', qty: 1 } },
    { input: "dos pots d'infusi√≥ de camamilla",
      expected: { action: 'add', product: "pots d'infusi√≥ de camamilla", qty: 2 } },
    { input: "barra de xocolata de cinc-cents grams que caduqui el vint-i-tres de mar√ß del dos mil vint-i-vuit",
      expected: { action: 'add', product: 'barra de xocolata de cinc-cents grams', qty: 1, expiry: '2028-03-23' } },
    // Speech-to-text variations
    { input: "afegeix una barra de xocolata de cinc cents grams que caduqui el vint i tres de mar√ß del dos mil vint i vuit",
      expected: { action: 'add', product: 'barra de xocolata de cinc-cents grams', qty: 1, expiry: '2028-03-23' } },
    { input: "afegeix tres paquets de te verd que caduca el 15 de juny",
      expected: { action: 'add', product: 'paquets de te verd', qty: 3, expiry_day: 15, expiry_month: 6 } },
  ];

  let pass = 0, fail = 0;
  for (const t of tests) {
    const text = normalizeVoiceText(t.input.toLowerCase());
    const action = extractAction(text);
    const qty = extractQuantity(text);
    const expiry = extractExpiry(text);
    const product = extractProductName(text);
    const errors = [];

    if (t.expected.action && action !== t.expected.action) errors.push(`action: got "${action}" expected "${t.expected.action}"`);
    if (t.expected.product && product !== t.expected.product) errors.push(`product: got "${product}" expected "${t.expected.product}"`);
    if (t.expected.qty && qty !== t.expected.qty) errors.push(`qty: got ${qty} expected ${t.expected.qty}`);
    if (t.expected.expiry && expiry !== t.expected.expiry) errors.push(`expiry: got "${expiry}" expected "${t.expected.expiry}"`);
    if (t.expected.expiry_day && expiry) {
      const d = parseInt(expiry.split('-')[2]); if (d !== t.expected.expiry_day) errors.push(`expiry day: got ${d} expected ${t.expected.expiry_day}`);
    }
    if (t.expected.expiry_month && expiry) {
      const m = parseInt(expiry.split('-')[1]); if (m !== t.expected.expiry_month) errors.push(`expiry month: got ${m} expected ${t.expected.expiry_month}`);
    }

    if (errors.length === 0) { pass++; console.log(`‚úì "${t.input.substring(0,50)}..."`); }
    else { fail++; console.error(`‚úó "${t.input.substring(0,50)}..." ‚Üí ${errors.join(', ')}`); }
  }
  console.log(`\nResults: ${pass}/${pass+fail} passed${fail > 0 ? ` (${fail} FAILED)` : ' ‚Äî ALL PASS'}`);
}

function speakCatalan(text) {
  if (!('speechSynthesis' in window)) return;
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = 'ca-ES';
  utterance.rate = 1.0;
  utterance.pitch = 1.0;
  // Try to find a Catalan voice
  const voices = speechSynthesis.getVoices();
  const catalanVoice = voices.find(v => v.lang.startsWith('ca'));
  if (catalanVoice) utterance.voice = catalanVoice;
  speechSynthesis.speak(utterance);
}

// Preload voices (some browsers need this)
if ('speechSynthesis' in window) {
  speechSynthesis.onvoiceschanged = () => { speechSynthesis.getVoices(); };
}

// Initialize voice on DOM ready
document.addEventListener('DOMContentLoaded', () => {
  initVoice();
});

// PWA: Register service worker if available (optional, for offline support)
if ('serviceWorker' in navigator) {
  // Only register if sw.js exists - graceful fallback
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}
</script>
</body>
</html>
